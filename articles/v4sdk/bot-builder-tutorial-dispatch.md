---
title: Integración de varios servicios de LUIS y QnA con la herramienta de distribución | Microsoft Docs
description: Obtenga información sobre cómo usar LUIS y QnA Maker en su bot.
keywords: LUIS, QnA, herramienta de distribución, varios servicios
author: DeniseMak
ms.author: v-demak
manager: kamrani
ms.topic: article
ms.prod: bot-framework
ms.date: 08/27/2018
monikerRange: azure-bot-service-4.0
ms.openlocfilehash: 02dffcdd8cb4fd27f59fa8a763d7f2027aa0bcf2
ms.sourcegitcommit: 0b2be801e55f6baa048b49c7211944480e83ba95
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 08/28/2018
ms.locfileid: "43115040"
---
# <a name="integrate-multiple-luis-and-qna-services-with-the-dispatch-tool"></a><span data-ttu-id="4f010-104">Integración de varios servicios de LUIS y QnA con la herramienta de distribución</span><span class="sxs-lookup"><span data-stu-id="4f010-104">Integrate multiple LUIS and QnA services with the Dispatch tool</span></span>

[!INCLUDE [pre-release-label](../includes/pre-release-label.md)]

<span data-ttu-id="4f010-105">En este tutorial se muestra cómo usar un modelo de LUIS generado por la herramienta de distribución, a fin de integrar el bot con varias aplicaciones de Language Understanding (LUIS) y servicios QnA Maker.</span><span class="sxs-lookup"><span data-stu-id="4f010-105">This tutorial demonstrates how to use a LUIS model generated by the Dispatch tool, to integrate your bot with multiple Language Understanding (LUIS) apps and QnAMaker services.</span></span> 

<span data-ttu-id="4f010-106">Imagine que ha desarrollado los servicios siguientes y que quiere crear un bot que se integre con todos ellos.</span><span class="sxs-lookup"><span data-stu-id="4f010-106">Imagine you've developed the following services, and you want to create a bot that integrates with all of them.</span></span>

| <span data-ttu-id="4f010-107">Tipo de servicio</span><span class="sxs-lookup"><span data-stu-id="4f010-107">Service type</span></span> | <span data-ttu-id="4f010-108">NOMBRE</span><span class="sxs-lookup"><span data-stu-id="4f010-108">Name</span></span> | <span data-ttu-id="4f010-109">DESCRIPCIÓN</span><span class="sxs-lookup"><span data-stu-id="4f010-109">Description</span></span> |
|------|------|------|
| <span data-ttu-id="4f010-110">Aplicación de LUIS</span><span class="sxs-lookup"><span data-stu-id="4f010-110">LUIS app</span></span> | <span data-ttu-id="4f010-111">HomeAutomation</span><span class="sxs-lookup"><span data-stu-id="4f010-111">HomeAutomation</span></span> | <span data-ttu-id="4f010-112">Reconoce las intenciones HomeAutomation.TurnOn HomeAutomation.TurnOff y HomeAutomation.None.</span><span class="sxs-lookup"><span data-stu-id="4f010-112">Recognizes the HomeAutomation.TurnOn, HomeAutomation.TurnOff, and HomeAutomation.None intents.</span></span>|
| <span data-ttu-id="4f010-113">Aplicación de LUIS</span><span class="sxs-lookup"><span data-stu-id="4f010-113">LUIS app</span></span> | <span data-ttu-id="4f010-114">Tiempo</span><span class="sxs-lookup"><span data-stu-id="4f010-114">Weather</span></span> | <span data-ttu-id="4f010-115">Reconoce las intenciones Weather.GetForecast y Weather.GetCondition.</span><span class="sxs-lookup"><span data-stu-id="4f010-115">Recognizes the Weather.GetForecast and Weather.GetCondition intents.</span></span>|
| <span data-ttu-id="4f010-116">Servicio QnA Maker</span><span class="sxs-lookup"><span data-stu-id="4f010-116">QnAMaker service</span></span> | <span data-ttu-id="4f010-117">Preguntas más frecuentes</span><span class="sxs-lookup"><span data-stu-id="4f010-117">FAQ</span></span>  | <span data-ttu-id="4f010-118">Proporciona respuestas a preguntas sobre un sistema de iluminación de automatización del hogar</span><span class="sxs-lookup"><span data-stu-id="4f010-118">Provides answers to questions about a home automation lighting system</span></span> |

<span data-ttu-id="4f010-119">Primero vamos a crear las aplicaciones y los servicios y luego los integraremos con la herramienta de distribución.</span><span class="sxs-lookup"><span data-stu-id="4f010-119">Let's first create the apps and services, then integrate them together using the Dispatch tool.</span></span>

## <a name="create-the-luis-apps"></a><span data-ttu-id="4f010-120">Crear las aplicaciones de LUIS</span><span class="sxs-lookup"><span data-stu-id="4f010-120">Create the LUIS apps</span></span>

<span data-ttu-id="4f010-121">La forma más rápida de crear las aplicaciones de LUIS *HomeAutomation* y *Weather* consiste en descargar los archivos [homeautomation.json][HomeAutomationJSON] y [weather.json][WeatherJSON].</span><span class="sxs-lookup"><span data-stu-id="4f010-121">The fastest way to create the *HomeAutomation* and *Weather* LUIS apps is to download the [homeautomation.json][HomeAutomationJSON] and [weather.json][WeatherJSON] files.</span></span> <span data-ttu-id="4f010-122">A continuación, siga estos pasos para importar estas dos aplicaciones de LUIS.</span><span class="sxs-lookup"><span data-stu-id="4f010-122">Then follow these steps to import these two LUIS apps.</span></span>

1. <span data-ttu-id="4f010-123">Vaya al [sitio web de LUIS](https://www.luis.ai/home) e inicie sesión.</span><span class="sxs-lookup"><span data-stu-id="4f010-123">Go to the [LUIS website](https://www.luis.ai/home) and sign in.</span></span> 
2. <span data-ttu-id="4f010-124">En la página **My Apps** (Mis aplicaciones), haga clic en **Import new app** (Importar nueva aplicación).</span><span class="sxs-lookup"><span data-stu-id="4f010-124">From the **My Apps** page, click **Import new app**.</span></span>
   1. <span data-ttu-id="4f010-125">Para la aplicación *homeautomation*, elija el archivo **homeautomation.json** y asígnele el nombre "homeautomation".</span><span class="sxs-lookup"><span data-stu-id="4f010-125">For the *homeautomation* app, choose the **homeautomation.json** file and name it "homeautomation".</span></span> <span data-ttu-id="4f010-126">Haga clic en **Done** (Listo) para importar la aplicación.</span><span class="sxs-lookup"><span data-stu-id="4f010-126">Click **Done** to import the app.</span></span> <span data-ttu-id="4f010-127">Después de importar la aplicación, haga clic en **Publish** (Publicar) para publicar la aplicación.</span><span class="sxs-lookup"><span data-stu-id="4f010-127">After the app is imported, click **Publish** to publish the app.</span></span>
   1. <span data-ttu-id="4f010-128">Para la aplicación *weather*, elija el archivo **weather.json** y asígnele el nombre "weather".</span><span class="sxs-lookup"><span data-stu-id="4f010-128">For the *weather* app, choose the **weather.json** file and name it "weather".</span></span> <span data-ttu-id="4f010-129">Haga clic en **Done** (Listo) para importar la aplicación.</span><span class="sxs-lookup"><span data-stu-id="4f010-129">Click **Done** to import the app.</span></span> <span data-ttu-id="4f010-130">Después de importar la aplicación, haga clic en **Publish** (Publicar) para publicar la aplicación.</span><span class="sxs-lookup"><span data-stu-id="4f010-130">After the app is imported, click **Publish** to publish the app.</span></span>

## <a name="create-the-qna-cognitive-service-in-azure"></a><span data-ttu-id="4f010-131">Crear el servicio cognitivo de QnA en Azure</span><span class="sxs-lookup"><span data-stu-id="4f010-131">Create the QnA Cognitive Service in Azure</span></span>

<span data-ttu-id="4f010-132">Un servicio QnA Maker está formado por dos partes: el servicio cognitivo de Azure y la base de conocimiento de pares de preguntas y respuestas que se publica mediante el servicio cognitivo.</span><span class="sxs-lookup"><span data-stu-id="4f010-132">A QnA Maker service involves two parts, which are the Cognitive Service in Azure, and the knowledge base of Q&A pairs that you publish using the Cognitive Service.</span></span> <span data-ttu-id="4f010-133">Cuando se crea la base de conocimiento, para vincularla al servicio de Azure, elija el **nombre del servicio de Azure** que ha creado en este paso.</span><span class="sxs-lookup"><span data-stu-id="4f010-133">When you create your Knowledgebase, you can link it to the Azure service by choosing the **Azure service name** you created in this step.</span></span>

<span data-ttu-id="4f010-134">Para crear el servicio de Cognitive Services en Azure, inicie sesión en [Azure Portal](https://portal.azure.com) y haga lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="4f010-134">To create the Cognitive Service in Azure, log in to the [Azure portal](https://portal.azure.com), and do the following:</span></span>

1. <span data-ttu-id="4f010-135">Haga clic en **Todos los servicios**.</span><span class="sxs-lookup"><span data-stu-id="4f010-135">Click **All services**.</span></span>
1. <span data-ttu-id="4f010-136">Busque en `Cognitive` y seleccione **Cognitive Services**.</span><span class="sxs-lookup"><span data-stu-id="4f010-136">Search on `Cognitive` and select **Cognitive Services**.</span></span>
1. <span data-ttu-id="4f010-137">Haga clic en **Agregar**.</span><span class="sxs-lookup"><span data-stu-id="4f010-137">Click **Add**.</span></span>
1. <span data-ttu-id="4f010-138">Busque en `QnA` y seleccione **QnA Maker**.</span><span class="sxs-lookup"><span data-stu-id="4f010-138">Search on `QnA` and select **QnA Maker**.</span></span>
1. <span data-ttu-id="4f010-139">En la hoja de QnA Maker, haga clic en **Crear**.</span><span class="sxs-lookup"><span data-stu-id="4f010-139">On the QnA Maker blade, click **Create**.</span></span>
1. <span data-ttu-id="4f010-140">Rellene la información y cree el servicio QnA Maker.</span><span class="sxs-lookup"><span data-stu-id="4f010-140">Fill in the information and create the QnA Maker service.</span></span>

    <!-- TODO: Add screenshot.-->

    * <span data-ttu-id="4f010-141">Escriba un nombre para el servicio.</span><span class="sxs-lookup"><span data-stu-id="4f010-141">Enter a name for the service.</span></span> <span data-ttu-id="4f010-142">Para este tutorial usaremos `SmartLightQnA`.</span><span class="sxs-lookup"><span data-stu-id="4f010-142">For this tutorial we'll use `SmartLightQnA`.</span></span>
    * <span data-ttu-id="4f010-143">Seleccione la suscripción que se va a usar.</span><span class="sxs-lookup"><span data-stu-id="4f010-143">Select the subscription to use.</span></span>
    * <span data-ttu-id="4f010-144">Seleccione el plan de tarifa que se va a usar. Ahora usaremos el plan F0 (gratis).</span><span class="sxs-lookup"><span data-stu-id="4f010-144">Select the management pricing tier to use; we'll use the F0 (free) tier.</span></span>
    * <span data-ttu-id="4f010-145">Cree el grupo de recursos que se va a usar o seleccione uno nuevo.</span><span class="sxs-lookup"><span data-stu-id="4f010-145">Create one, or select a new, resource group to use.</span></span> <span data-ttu-id="4f010-146">En este tutorial, vamos a crear el grupo de recursos `SmartLightQnA`.</span><span class="sxs-lookup"><span data-stu-id="4f010-146">For this tutorial we'll create a new `SmartLightQnA` resource group.</span></span>
    * <span data-ttu-id="4f010-147">Seleccione un plan de tarifa de búsqueda; aquí usaremos el plan B (básico).</span><span class="sxs-lookup"><span data-stu-id="4f010-147">Select a search pricing tier; we'll use the B (basic) tier.</span></span>
    * <span data-ttu-id="4f010-148">Seleccione una ubicación de búsqueda; aquí usaremos `West US`.</span><span class="sxs-lookup"><span data-stu-id="4f010-148">Select a search location; we'll use `West US`.</span></span>
    * <span data-ttu-id="4f010-149">Escriba el nombre que se usará para la aplicación; en este caso, mantendremos el valor predeterminado `SmartLightQnA`.</span><span class="sxs-lookup"><span data-stu-id="4f010-149">Enter an application name to use; we'll keep the default `SmartLightQnA`.</span></span>
    * <span data-ttu-id="4f010-150">Seleccione la ubicación del sitio web; aquí usaremos `West US`.</span><span class="sxs-lookup"><span data-stu-id="4f010-150">Select the website location; we'll use `West US`.</span></span>
    * <span data-ttu-id="4f010-151">Mantenga el valor predeterminado consistente en habilitar Application Insights.</span><span class="sxs-lookup"><span data-stu-id="4f010-151">Keep the default of enabling app insights.</span></span>
    * <span data-ttu-id="4f010-152">Seleccione una ubicación de Application Insights; aquí usaremos `West US`.</span><span class="sxs-lookup"><span data-stu-id="4f010-152">Select an app insights location; we'll use `West US`.</span></span>
    * <span data-ttu-id="4f010-153">Haga clic en **Crear** para crear el servicio QnA Maker.</span><span class="sxs-lookup"><span data-stu-id="4f010-153">Click **Create** to create your QnA Maker service.</span></span>
    * <span data-ttu-id="4f010-154">Azure crea y empieza a implementar el servicio.</span><span class="sxs-lookup"><span data-stu-id="4f010-154">Azure creates and begins to deploy your service.</span></span>

1. <span data-ttu-id="4f010-155">Una vez que se haya implementado, vea la notificación y haga clic en **Go to resource** (Ir al recurso) para ir a la hoja del servicio.</span><span class="sxs-lookup"><span data-stu-id="4f010-155">Once the service is deployed, view the notification and click **Go to resource** to navigate to the blade for the service.</span></span>
1. <span data-ttu-id="4f010-156">Haga clic en **Claves** para obtener las claves.</span><span class="sxs-lookup"><span data-stu-id="4f010-156">Click **Keys** to grab your keys.</span></span>

    * <span data-ttu-id="4f010-157">Copie el nombre del servicio y la primera clave.</span><span class="sxs-lookup"><span data-stu-id="4f010-157">Copy the name of the service and the first key.</span></span> <span data-ttu-id="4f010-158">Deberá utilizar este nombre al crear la base de conocimiento para que el servicio esté vinculado con ella.</span><span class="sxs-lookup"><span data-stu-id="4f010-158">You'll need to use this name when creating your knowledge base so that the service is linked with the KB.</span></span> <span data-ttu-id="4f010-159">También usará esta clave en lugar de YOUR-AZURE-QNA-SUBSCRIPTION-KEY en los siguientes pasos del distribuidor.</span><span class="sxs-lookup"><span data-stu-id="4f010-159">You will also use this key in place of YOUR-AZURE-QNA-SUBSCRIPTION-KEY in the dispatcher steps below.</span></span>
    * <span data-ttu-id="4f010-160">Obtendrá dos claves para poder volver a generar una de ellas de cada vez sin tener que interrumpir el servicio.</span><span class="sxs-lookup"><span data-stu-id="4f010-160">You get two keys so that you can regenerate one of them at a time without having to interrupt your service.</span></span>

## <a name="create-and-publish-the-qna-maker-knowledge-base"></a><span data-ttu-id="4f010-161">Crear y publicar la base de conocimiento de QnA Maker</span><span class="sxs-lookup"><span data-stu-id="4f010-161">Create and publish the QnA Maker knowledge base</span></span>

<span data-ttu-id="4f010-162">Para crear la base de conocimiento, realice lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="4f010-162">To create the KB, do the following:</span></span>

1. <span data-ttu-id="4f010-163">Vaya al [sitio web de QnA Maker](https://qnamaker.ai) e inicie sesión.</span><span class="sxs-lookup"><span data-stu-id="4f010-163">Go to the [QnA Maker website](https://qnamaker.ai) and sign in.</span></span> 
1. <span data-ttu-id="4f010-164">Haga clic en **Create a knowledge base** (Crear una base de conocimiento) para crear una nueva base de conocimiento.</span><span class="sxs-lookup"><span data-stu-id="4f010-164">Click **Create a knowledge base** to create a new knowledge base.</span></span> <span data-ttu-id="4f010-165">Como se ha creado el servicio de Cognitive Services en Azure, puede omitir el **Paso 1**.</span><span class="sxs-lookup"><span data-stu-id="4f010-165">Since you created the Cognitive Service in Azure already, you can skip **Step 1**.</span></span>
1. <span data-ttu-id="4f010-166">En el **Paso 2**, para el campo **Azure QnA service**, (Servicio de Azure QnA) elija el nombre del servicio de Cognitive Services que creó en Azure.</span><span class="sxs-lookup"><span data-stu-id="4f010-166">In **Step 2**, for the field **Azure QnA service**, choose the Cognitive Service name you created in Azure.</span></span> <span data-ttu-id="4f010-167">De este modo, se asociará esta base de conocimiento con el servicio que creó en Azure.</span><span class="sxs-lookup"><span data-stu-id="4f010-167">This will associate this KB with the service you created in Azure.</span></span>
1. <span data-ttu-id="4f010-168">En el **Paso 3**, asigne a la base de conocimiento el nombre "FAQ".</span><span class="sxs-lookup"><span data-stu-id="4f010-168">In **Step 3**, name this KB "FAQ".</span></span> 
1. <span data-ttu-id="4f010-169">En el **Paso 4**, rellene la base de conocimiento con este [archivo TSV de ejemplo][FAQ_TSV].</span><span class="sxs-lookup"><span data-stu-id="4f010-169">In **Step 4**, populate the KB with this [sample TSV file][FAQ_TSV].</span></span> <span data-ttu-id="4f010-170">O bien, use el contenido de una página web.</span><span class="sxs-lookup"><span data-stu-id="4f010-170">Or, use content from a web page.</span></span> <span data-ttu-id="4f010-171">En ese caso, pegue el vínculo en el campo **URL**.</span><span class="sxs-lookup"><span data-stu-id="4f010-171">In that case, paste the link into the **URL** field.</span></span>
1. <span data-ttu-id="4f010-172">En el **Paso 5**, haga clic en **Create your KB** (Crear la base de conocimiento) para crear la base de conocimiento.</span><span class="sxs-lookup"><span data-stu-id="4f010-172">In **Step 5**, click **Create your KB** to create the KB.</span></span>

<span data-ttu-id="4f010-173">Una vez que se crea la base de conocimiento, deberá **publicar** la base de conocimiento para obtener su identificador y el punto de conexión.</span><span class="sxs-lookup"><span data-stu-id="4f010-173">After the KB is create, you need to **Publish** the KB to get the KB ID and endpoint.</span></span> <span data-ttu-id="4f010-174">Los necesitará en la última parte de este proceso.</span><span class="sxs-lookup"><span data-stu-id="4f010-174">You will need these in the later part of this process.</span></span>


## <a name="use-the-dispatch-tool-to-create-the-dispatcher-luis-app"></a><span data-ttu-id="4f010-175">Usar la herramienta de distribución para crear la aplicación de LUIS de distribuidor</span><span class="sxs-lookup"><span data-stu-id="4f010-175">Use the Dispatch tool to create the dispatcher LUIS app</span></span>
<span data-ttu-id="4f010-176">Ahora que tiene creadas las dos aplicaciones de LUIS y una base de conocimiento, vamos a usar la herramienta de distribución para generar una aplicación de LUIS que las combina como una única aplicación de LUIS.</span><span class="sxs-lookup"><span data-stu-id="4f010-176">Now that you have your two LUIS apps and a KB created; next, let's use the Dispatch tool to generate a LUIS app that combines them as one LUIS app.</span></span> 

### <a name="step-1-install-the-dispatch-tool"></a><span data-ttu-id="4f010-177">Paso 1: Instalación de la herramienta de distribución</span><span class="sxs-lookup"><span data-stu-id="4f010-177">Step 1: Install the Dispatch tool</span></span>

<span data-ttu-id="4f010-178">Abra una ventana del **símbolo del sistema** y vaya al proyecto del distribuidor.</span><span class="sxs-lookup"><span data-stu-id="4f010-178">Open a **Command prompt** window and navigate to your dispatcher project.</span></span> <span data-ttu-id="4f010-179">A continuación, ejecute el siguiente comando de NPM para instalar la [herramienta de distribución][DispatchTool].</span><span class="sxs-lookup"><span data-stu-id="4f010-179">Then, run the following NPM command to install the [Dispatch tool][DispatchTool].</span></span>

```cmd
npm install -g botdispatch
```

### <a name="step-2-initialize-the-dispatch-tool"></a><span data-ttu-id="4f010-180">Paso 2: Inicialización de la herramienta de distribución</span><span class="sxs-lookup"><span data-stu-id="4f010-180">Step 2: Initialize the Dispatch tool</span></span>

<span data-ttu-id="4f010-181">Ejecute el comando siguiente para inicializar la herramienta de distribución con el nombre `CombineWeatherAndLights`.</span><span class="sxs-lookup"><span data-stu-id="4f010-181">Run the following command to initialize the Dispatch tool with the name `CombineWeatherAndLights`.</span></span> <span data-ttu-id="4f010-182">Sustituya la [clave de creación de LUIS](https://docs.microsoft.com/en-us/azure/cognitive-services/LUIS/luis-concept-keys) por `"YOUR-LUIS-AUTHORING-KEY"` en la siguiente línea de comandos.</span><span class="sxs-lookup"><span data-stu-id="4f010-182">Substitute your [LUIS authoring key](https://docs.microsoft.com/en-us/azure/cognitive-services/LUIS/luis-concept-keys) for `"YOUR-LUIS-AUTHORING-KEY"` in the command line below.</span></span>

```cmd
dispatch init -name CombineWeatherAndLights -luisAuthoringKey "YOUR-LUIS-AUTHORING-KEY" -luisAuthoringRegion westus
```

### <a name="step-3-add-apps-to-dispatcher"></a><span data-ttu-id="4f010-183">Paso 3: Adición de aplicaciones al distribuidor</span><span class="sxs-lookup"><span data-stu-id="4f010-183">Step 3: Add apps to dispatcher</span></span>

<span data-ttu-id="4f010-184">Obtenga el identificador de aplicación de LUIS de cada una de las aplicaciones de LUIS que ha creado.</span><span class="sxs-lookup"><span data-stu-id="4f010-184">For each of the LUIS apps that you have created, get the LUIS app ID.</span></span> <span data-ttu-id="4f010-185">Los encontrará para cada aplicación en **My Apps** (Mis aplicaciones), en el [sitio de LUIS](https://www.luis.ai/home). Haga clic en el nombre de la aplicación y, luego, en **Settings** (Configuración) para ver el **Application ID** (Identificador de aplicación).</span><span class="sxs-lookup"><span data-stu-id="4f010-185">Those can be found for each app under **My Apps** on the [LUIS site](https://www.luis.ai/home); click the app name, and then click **Settings** to see the **Application ID**.</span></span> <span data-ttu-id="4f010-186">Use la misma *clave de creación de LUIS* que obtuvo en el **Paso 2**.</span><span class="sxs-lookup"><span data-stu-id="4f010-186">Use the same *LUIS authoring key* you got from **Step 2**.</span></span>

<span data-ttu-id="4f010-187">Ejecute el siguiente comando para cada una de las aplicaciones de LUIS que creó (p. ej.: **homeautomation** y **weather**).</span><span class="sxs-lookup"><span data-stu-id="4f010-187">Run the following command for each of the LUIS apps you created (e.g.: **homeautomation** and **weather**).</span></span> <span data-ttu-id="4f010-188">No olvide reemplazar el identificador apropiado para el siguiente comando.</span><span class="sxs-lookup"><span data-stu-id="4f010-188">Be sure to replace the appropriate ID for the appropriate command below.</span></span>

```
dispatch add -type luis -id "HOMEAUTOMATION-APP-ID" -name homeautomation -version 0.1 -key "YOUR-LUIS-AUTHORING-KEY"
dispatch add -type luis -id "WEATHER-APP-ID" -name weather -version 0.1 -key "YOUR-LUIS-AUTHORING-KEY"

```

<span data-ttu-id="4f010-189">A continuación, ejecute el siguiente comando para agregar la base de conocimiento de QnAMaker.</span><span class="sxs-lookup"><span data-stu-id="4f010-189">Next, add the QnAMaker KB by running the following command.</span></span> <span data-ttu-id="4f010-190">En este comando, `QNA-KB-ID` hace referencia al identificador de la base de conocimiento que obtuvo después de su publicación y `YOUR-AZURE-QNA-SUBSCRIPTION-KEY` hace referencia a la clave obtenida en el servicio de Cognitive Services que creó en Azure.</span><span class="sxs-lookup"><span data-stu-id="4f010-190">In this command, the `QNA-KB-ID` refers to the KB ID given to you after you have published the KB and the `YOUR-AZURE-QNA-SUBSCRIPTION-KEY` refers to the key obtained from the Cognitive Service you created in Azure.</span></span>

```
dispatch add -type qna -id "QNA-KB-ID" -name faq -key "YOUR-AZURE-QNA-SUBSCRIPTION-KEY"
```

### <a name="step-4-create-the-dispatcher-luis-app"></a><span data-ttu-id="4f010-191">Paso 4: Creación de la aplicación de LUIS de distribución</span><span class="sxs-lookup"><span data-stu-id="4f010-191">Step 4: Create the dispatcher LUIS app</span></span>

<span data-ttu-id="4f010-192">Después de agregar todas las aplicaciones a la herramienta de distribución, ejecute el siguiente comando para crear la aplicación de distribución.</span><span class="sxs-lookup"><span data-stu-id="4f010-192">After all of the apps are added to the Dispatch tool, run the following command to create the dispatch app.</span></span> <span data-ttu-id="4f010-193">Si desea inspeccionar el archivo de distribución, puede encontrar la información en un archivo con la extensión **.dispatch**.</span><span class="sxs-lookup"><span data-stu-id="4f010-193">If you want to inspect the dispatch file, you can find the info in a file with the extension **.dispatch**.</span></span>

```
dispatch create
```

<span data-ttu-id="4f010-194">Este comando crea la aplicación de LUIS de distribución denominada **CombineWeatherAndLights**.</span><span class="sxs-lookup"><span data-stu-id="4f010-194">This command creates the dispatcher LUIS app named **CombineWeatherAndLights**.</span></span> <span data-ttu-id="4f010-195">Puede ver la nueva aplicación en [https://www.luis.ai/home](https://www.luis.ai/home).</span><span class="sxs-lookup"><span data-stu-id="4f010-195">You can see the new app in [https://www.luis.ai/home](https://www.luis.ai/home).</span></span> 

![Aplicación de distribuidor en LUIS.ai](media/tutorial-dispatch/dispatch-app-in-luis.png)

<span data-ttu-id="4f010-197">Haga clic en la nueva aplicación.</span><span class="sxs-lookup"><span data-stu-id="4f010-197">Click on the new app.</span></span> <span data-ttu-id="4f010-198">En **Intenciones** puede ver tiene las intenciones `l_homeautomation`, `l_weather` y `q_faq`.</span><span class="sxs-lookup"><span data-stu-id="4f010-198">Under **Intents** you can see it has the `l_homeautomation`, `l_weather`, and `q_faq` intents.</span></span>

![Intenciones del distribuidor en LUIS.ai](media/tutorial-dispatch/dispatch-intents-in-luis.png)

<span data-ttu-id="4f010-200">Haga clic en el botón **Entrenar** para entrenar la aplicación de LUIS y use la pestaña **PUBLICAR** para [publicarla](https://docs.microsoft.com/en-us/azure/cognitive-services/LUIS/publishapp).</span><span class="sxs-lookup"><span data-stu-id="4f010-200">Click the **Train** button to train the LUIS app, and use the **PUBLISH** tab to [publish](https://docs.microsoft.com/en-us/azure/cognitive-services/LUIS/publishapp) it.</span></span> <span data-ttu-id="4f010-201">Haga clic en **Settings** (Configuración) para copiar el identificador de la nueva aplicación.</span><span class="sxs-lookup"><span data-stu-id="4f010-201">Click on **Settings** to copy the ID of the new app.</span></span> <span data-ttu-id="4f010-202">Necesitará este identificador para que el bot se conecte a esta aplicación.</span><span class="sxs-lookup"><span data-stu-id="4f010-202">You will need this ID for the bot to connect to this app.</span></span>

## <a name="create-the-bot"></a><span data-ttu-id="4f010-203">Crear el bot</span><span class="sxs-lookup"><span data-stu-id="4f010-203">Create the bot</span></span>

<span data-ttu-id="4f010-204">Ahora puede enlazar las intenciones de la aplicación de distribuidor con la lógica de su bot, que enruta los mensajes al servicio QnA Maker y las aplicaciones de LUIS originales.</span><span class="sxs-lookup"><span data-stu-id="4f010-204">Now you can hook up the dispatcher app's intents to logic in your bot, which routes messages to the original LUIS apps and QnAMaker service.</span></span>

<span data-ttu-id="4f010-205">Puede usar como punto de partida el ejemplo que se incluye con Bot Builder SDK.</span><span class="sxs-lookup"><span data-stu-id="4f010-205">You can use the sample included with the Bot Builder SDK as a starting point.</span></span>

# <a name="ctabcsaddref"></a>[<span data-ttu-id="4f010-206">C#</span><span class="sxs-lookup"><span data-stu-id="4f010-206">C#</span></span>](#tab/csaddref)

<span data-ttu-id="4f010-207">Comience con el código del [ejemplo de distribución de LUIS][DispatchBotCS].</span><span class="sxs-lookup"><span data-stu-id="4f010-207">Start with the code in the [LUIS Dispatch sample][DispatchBotCS].</span></span> <span data-ttu-id="4f010-208">En Visual Studio, [actualice los paquetes Nuget](https://docs.microsoft.com/en-us/nuget/tools/package-manager-ui#updating-a-package) a las últimas versiones preliminares de lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="4f010-208">In Visual Studio, [update Nuget packages](https://docs.microsoft.com/en-us/nuget/tools/package-manager-ui#updating-a-package) to the latest prerelease versions of the following:</span></span>

* `Microsoft.Bot.Builder.Integration.AspNet.Core`
* <span data-ttu-id="4f010-209">`Microsoft.Bot.Builder.Ai.QnA` (necesario para QnA Maker)</span><span class="sxs-lookup"><span data-stu-id="4f010-209">`Microsoft.Bot.Builder.Ai.QnA` (required for QnA Maker)</span></span>
* <span data-ttu-id="4f010-210">`Microsoft.Bot.Builder.Ai.Luis` (necesario para LUIS)</span><span class="sxs-lookup"><span data-stu-id="4f010-210">`Microsoft.Bot.Builder.Ai.Luis` (required for LUIS)</span></span>

# <a name="javascripttabjsaddref"></a>[<span data-ttu-id="4f010-211">JavaScript</span><span class="sxs-lookup"><span data-stu-id="4f010-211">JavaScript</span></span>](#tab/jsaddref)

<span data-ttu-id="4f010-212">Descargue el [ejemplo de distribución de LUIS][DispatchBotJs].</span><span class="sxs-lookup"><span data-stu-id="4f010-212">Download the [LUIS Dispatch sample][DispatchBotJs].</span></span>  <span data-ttu-id="4f010-213">Instale los paquetes necesarios, incluido el paquete `botbuilder-ai` para LUIS y QnA Maker, mediante npm:</span><span class="sxs-lookup"><span data-stu-id="4f010-213">Install the required packages, including the `botbuilder-ai` package for LUIS and QnA Maker, using npm:</span></span>

* `npm install --save botbuilder@preview`
* `npm install --save botbuilder-ai@preview`

---


<span data-ttu-id="4f010-214">Configure el ejemplo de modo que use la aplicación de distribuidor.</span><span class="sxs-lookup"><span data-stu-id="4f010-214">Set up the sample to use the dispatcher app.</span></span>

# <a name="ctabcsbotconfig"></a>[<span data-ttu-id="4f010-215">C#</span><span class="sxs-lookup"><span data-stu-id="4f010-215">C#</span></span>](#tab/csbotconfig)

<span data-ttu-id="4f010-216">En **appsettings.json**, en el [ejemplo de distribución de LUIS][DispatchBotCS], edite los campos siguientes.</span><span class="sxs-lookup"><span data-stu-id="4f010-216">In **appsettings.json** in the [LUIS Dispatch sample][DispatchBotCS], edit the following fields.</span></span>

| <span data-ttu-id="4f010-217">NOMBRE</span><span class="sxs-lookup"><span data-stu-id="4f010-217">Name</span></span> | <span data-ttu-id="4f010-218">DESCRIPCIÓN</span><span class="sxs-lookup"><span data-stu-id="4f010-218">Description</span></span> |
|------|------|
| `Luis-SubscriptionKey` |  <span data-ttu-id="4f010-219">Clave de suscripción de LUIS.</span><span class="sxs-lookup"><span data-stu-id="4f010-219">Your LUIS subscription key.</span></span> <span data-ttu-id="4f010-220">Puede ser una clave de punto de conexión o una clave de creación, como se describe [aquí](https://docs.microsoft.com/en-us/azure/cognitive-services/luis/luis-concept-keys).</span><span class="sxs-lookup"><span data-stu-id="4f010-220">This can be an endpoint key or an authoring key, described [here](https://docs.microsoft.com/en-us/azure/cognitive-services/luis/luis-concept-keys).</span></span> | 
| `Luis-ModelId-Dispatcher` | <span data-ttu-id="4f010-221">Identificador de la aplicación de LUIS generada por la herramienta de distribución.</span><span class="sxs-lookup"><span data-stu-id="4f010-221">App ID for the LUIS app that the Dispatch tool generates.</span></span> | 
| `Luis-ModelId-HomeAutomation` | <span data-ttu-id="4f010-222">Identificador de la aplicación que ha creado a partir de homeautomation.json.</span><span class="sxs-lookup"><span data-stu-id="4f010-222">App ID of the app you created from homeautomation.json</span></span>  | 
| `Luis-ModelId-Weather` | <span data-ttu-id="4f010-223">Identificador de la aplicación que ha creado a partir de weather.json.</span><span class="sxs-lookup"><span data-stu-id="4f010-223">App ID of the app you created from weather.json</span></span> | 
| `QnAMaker-Endpoint-Url` | <span data-ttu-id="4f010-224">Debe establecerse en https://westus.api.cognitive.microsoft.com/qnamaker/v2.0 para los servicios QnA Maker de versión preliminar.</span><span class="sxs-lookup"><span data-stu-id="4f010-224">This should be set to https://westus.api.cognitive.microsoft.com/qnamaker/v2.0 for Preview QnA Maker services.</span></span> <br/><span data-ttu-id="4f010-225">Establezca esta opción en https://YOUR-QNA-SERVICE-NAME.azurewebsites.net/qnamaker para los servicios QnA Maker nuevos (disponibilidad general).</span><span class="sxs-lookup"><span data-stu-id="4f010-225">Set this to https://YOUR-QNA-SERVICE-NAME.azurewebsites.net/qnamaker for new (GA) QnA Maker services.</span></span>|
| `QnAMaker-SubscriptionKey` | <span data-ttu-id="4f010-226">La clave de suscripción de Azure QnA Maker.</span><span class="sxs-lookup"><span data-stu-id="4f010-226">Your Azure QnA Maker subscription key.</span></span> | 
| `QnAMaker-KnowledgeBaseId` | <span data-ttu-id="4f010-227">Identificador de la base de conocimiento que cree en el [portal de QnA Maker](https://qnamaker.ai).</span><span class="sxs-lookup"><span data-stu-id="4f010-227">The ID of the knowledge base you create at the [QnAMaker portal](https://qnamaker.ai).</span></span>| 



<span data-ttu-id="4f010-228">En **Startup.cs**, eche un vistazo al método `ConfigureServices`.</span><span class="sxs-lookup"><span data-stu-id="4f010-228">In **Startup.cs**, take a look at the `ConfigureServices` method.</span></span> <span data-ttu-id="4f010-229">Contiene código para inicializar `LuisRecognizerMiddleware` con el identificador de la aplicación de LUIS que acaba de generar.</span><span class="sxs-lookup"><span data-stu-id="4f010-229">It contains code to initialize `LuisRecognizerMiddleware` using the app ID of the LUIS app you just generated.</span></span>

```csharp
// This method gets called by the runtime. Use this method to add services to the container.
public void ConfigureServices(IServiceCollection services)
{
    services.AddSingleton(this.Configuration);
    services.AddBot<LuisDispatchBot>(options =>
    {
        options.CredentialProvider = new ConfigurationCredentialProvider(Configuration);

        var (luisModelId, luisSubscriptionKey, luisUri) = GetLuisConfiguration(this.Configuration, "Dispatcher");

        var luisModel = new LuisModel(luisModelId, luisSubscriptionKey, luisUri);

        // If you want to get all the intents and scores that LUIS recognized, set Verbose = true in luisOptions
        var luisOptions = new LuisRequest { Verbose = true };

        var middleware = options.Middleware;
        middleware.Add(new LuisRecognizerMiddleware(luisModel, luisOptions: luisOptions));
    });
}
```
<span data-ttu-id="4f010-230">Los métodos `GetLuisConfiguration` y `GetQnAMakerConfiguration` obtienen de appsettings.json la configuración de LUIS y de QnA.</span><span class="sxs-lookup"><span data-stu-id="4f010-230">The `GetLuisConfiguration` and `GetQnAMakerConfiguration` methods get your LUIS and QnA configuration from appsettings.json.</span></span>
```csharp
public static (string modelId, string subscriptionId, Uri uri) GetLuisConfiguration(IConfiguration configuration, string serviceName)
{
    var modelId = configuration.GetSection($"Luis-ModelId-{serviceName}")?.Value;
    var subscriptionId = configuration.GetSection("Luis-SubscriptionKey")?.Value;
    var uri = new Uri(configuration.GetSection("Luis-Url")?.Value);
    return (modelId, subscriptionId, uri);
}

public static (string knowledgeBaseId, string subscriptionKey, string uri) GetQnAMakerConfiguration(IConfiguration configuration)
{
    var knowledgeBaseId = configuration.GetSection("QnAMaker-KnowledgeBaseId")?.Value;
    var subscriptionKey = configuration.GetSection("QnAMaker-SubscriptionKey")?.Value;
    var uri = configuration.GetSection("QnAMaker-Endpoint-Url")?.Value;
    return (knowledgeBaseId, subscriptionKey, uri);
}
```

### <a name="dispatch-the-message"></a><span data-ttu-id="4f010-231">Distribuir el mensaje</span><span class="sxs-lookup"><span data-stu-id="4f010-231">Dispatch the message</span></span>

<span data-ttu-id="4f010-232">Eche un vistazo a **LuisDispatchBot.cs**, donde el bot distribuye el mensaje a la aplicación de LUIS o de QnA Maker para un subcomponente.</span><span class="sxs-lookup"><span data-stu-id="4f010-232">Take a look at **LuisDispatchBot.cs**, where the bot dispatches the message to the LUIS app or QnA Maker for a subcomponent.</span></span> 

<span data-ttu-id="4f010-233">En `DispatchToTopIntent`, si la aplicación de distribuidor detecta la intención `l_homeautomation` o `l_weather`, llama a un método `DispatchToTopIntent` que crea un `LuisRecognizer` para llamar a las aplicaciones originales `homeautomation` y `weather`.</span><span class="sxs-lookup"><span data-stu-id="4f010-233">In `DispatchToTopIntent`, if your dispatcher app detects the `l_homeautomation` or `l_weather` intent, it calls a `DispatchToTopIntent` method that creates a `LuisRecognizer` to call the original `homeautomation` and `weather` apps.</span></span> <span data-ttu-id="4f010-234">Si el bot detecta la intención `q_faq`, o bien la intención `none` que se usa como caso de reserva, llama a un método que realiza una consulta a QnA Maker.</span><span class="sxs-lookup"><span data-stu-id="4f010-234">If the bot detects the `q_faq` intent, or the `none` intent that is used as a fallback case, it calls a method that queries QnAMaker.</span></span>

> [!NOTE] 
> <span data-ttu-id="4f010-235">Si los nombres de intención `l_homeautomation`, `l_weather` o `q_faq` no coinciden con la aplicación de LUIS que ha creado mediante la herramienta de distribución, modifíquelos para que coincidan con la versión en minúsculas de los nombres de intención que se ven en el [portal de LUIS](https://www.luis.ai).</span><span class="sxs-lookup"><span data-stu-id="4f010-235">If the intent names `l_homeautomation`, `l_weather` or `q_faq` don't match the LUIS app you created using Dispatch, edit them to match the lower case version of the intent names you see in the [LUIS portal](https://www.luis.ai).</span></span>

```csharp
private async Task DispatchToTopIntent(ITurnContext context, (string intent, double score)? topIntent)
{
    switch (topIntent.Value.intent.ToLowerInvariant())
    {
        case "l_homeautomation":
            await DispatchToLuisModel(context, this.luisModelHomeAutomation, "home automation");
            break;
        case "l_weather":
            await DispatchToLuisModel(context, this.luisModelWeather, "weather");
            break;
        case "none":
        // You can provide logic here to handle the known None intent (none of the above).
        // In this example we fall through to the QnA intent.
        case "q_faq":
            await DispatchToQnAMaker(context, this.qnaEndpoint, "FAQ");
            break;
        default:
            // The intent didn't match any case, so just display the recognition results.
            await context.SendActivity($"Dispatch intent: {topIntent.Value.intent} ({topIntent.Value.score}).");

            break;
    }
}
```

<span data-ttu-id="4f010-236">El método `DispatchToQnAMaker` envía el mensaje del usuario al servicio QnA Maker.</span><span class="sxs-lookup"><span data-stu-id="4f010-236">The `DispatchToQnAMaker` method sends the user's message to the QnA Maker service.</span></span> <span data-ttu-id="4f010-237">Asegúrese de que ha publicado ese servicio en el [portal de QnA Maker](https://qnamaker.ai) antes de ejecutar el bot.</span><span class="sxs-lookup"><span data-stu-id="4f010-237">Make sure you have published that service in the [QnA Maker portal](https://qnamaker.ai) before you run the bot.</span></span>

```csharp
private static async Task DispatchToQnAMaker(ITurnContext context, QnAMakerEndpoint qnaOptions, string appName)
{
    QnAMaker qnaMaker = new QnAMaker(qnaOptions);
    if (!string.IsNullOrEmpty(context.Activity.Text))
    {
        var results = await qnaMaker.GetAnswers(context.Activity.Text.Trim()).ConfigureAwait(false);
        if (results.Any())
        {
            await context.SendActivity(results.First().Answer);
        }
        else
        {
            await context.SendActivity($"Couldn't find an answer in the {appName}.");
        }
    }
}
```

<span data-ttu-id="4f010-238">El método `DispatchToLuisModel` envía el mensaje del usuario a las aplicaciones de LUIS originales `homeautomation` y `weather`.</span><span class="sxs-lookup"><span data-stu-id="4f010-238">The `DispatchToLuisModel` method sends the user's message to the original `homeautomation` and `weather` LUIS apps.</span></span> <span data-ttu-id="4f010-239">Asegúrese de que ha publicado esas aplicaciones de LUIS en el [portal de LUIS](https://www.luis.ai) antes de ejecutar el bot.</span><span class="sxs-lookup"><span data-stu-id="4f010-239">Make sure you have published those LUIS apps in the [LUIS portal](https://www.luis.ai) before you run the bot.</span></span>

```csharp
private static async Task DispatchToLuisModel(ITurnContext context, LuisModel luisModel, string appName)
{
    await context.SendActivity($"Sending your request to the {appName} system ...");
    var (intents, entities) = await RecognizeAsync(luisModel, context.Activity.Text);

    await context.SendActivity($"Intents detected by the {appName} app:\n\n{string.Join("\n\n", intents)}");

    if (entities.Count() > 0)
    {
        await context.SendActivity($"The following entities were found in the message:\n\n{string.Join("\n\n", entities)}");
    }
    
    // Here, you can add code for calling the hypothetical home automation or weather service, 
    // passing in the appName and any intent or entity information that you need 
}
```

<span data-ttu-id="4f010-240">El método `RecognizeAsync` llama a un `LuisRecognizer` para obtener resultados de una aplicación de LUIS.</span><span class="sxs-lookup"><span data-stu-id="4f010-240">The `RecognizeAsync` method calls a `LuisRecognizer` to get results from a LUIS app.</span></span>

```cs
private static async Task<(IEnumerable<string> intents, IEnumerable<string> entities)> RecognizeAsync(LuisModel luisModel, string text)
{
    var luisRecognizer = new LuisRecognizer(luisModel);
    var recognizerResult = await luisRecognizer.Recognize(text, System.Threading.CancellationToken.None);

    // list the intents
    var intents = new List<string>();
    foreach (var intent in recognizerResult.Intents)
    {
        intents.Add($"'{intent.Key}', score {intent.Value}");
    }

    // list the entities
    var entities = new List<string>();
    foreach (var entity in recognizerResult.Entities)
    {
        if (!entity.Key.ToString().Equals("$instance"))
        {
            entities.Add($"{entity.Key}: {entity.Value.First}");
        }
    }

    return (intents, entities);
}
```

# <a name="javascripttabjsbotconfig"></a>[<span data-ttu-id="4f010-241">JavaScript</span><span class="sxs-lookup"><span data-stu-id="4f010-241">JavaScript</span></span>](#tab/jsbotconfig)

<span data-ttu-id="4f010-242">Comience con el código del [ejemplo de bot de distribución][DispatchBotJs].</span><span class="sxs-lookup"><span data-stu-id="4f010-242">Start with the code in the [Dispatch bot sample][DispatchBotJs].</span></span> <span data-ttu-id="4f010-243">Abra **app.js** y, opcionalmente, reemplace los campos `appId` por los identificadores de las aplicaciones de LUIS que ha creado.</span><span class="sxs-lookup"><span data-stu-id="4f010-243">Open **app.js** and optionally replace the `appId` fields with the IDs of the LUIS apps you created.</span></span> <span data-ttu-id="4f010-244">Si deja los campos `appId` como estaban originalmente, usará aplicaciones de LUIS públicas creadas con fines de demostración.</span><span class="sxs-lookup"><span data-stu-id="4f010-244">If you leave the `appId` fields as they originally are, you'll be using public LUIS apps created for demonstration purposes.</span></span> <span data-ttu-id="4f010-245">A igual que `LUIS_SUBSCRIPTION_KEY`, se puede encontrar en la página de publicación de cualquier aplicación de LUIS.</span><span class="sxs-lookup"><span data-stu-id="4f010-245">As for the `LUIS_SUBSCRIPTION_KEY`, you can find it in the Publish page of any LUIS app.</span></span> <span data-ttu-id="4f010-246">Aparece insertada en el vínculo del punto de conexión en dicha página.</span><span class="sxs-lookup"><span data-stu-id="4f010-246">It's embeded within the Endpoint link on that page.</span></span>

```javascript
// Packages
const { BotFrameworkAdapter, MemoryStorage, ConversationState } = require('botbuilder');
const { restify } = require('restify');
const { LuisRecognizer, QnAMaker } = require('botbuilder-ai');
const { DialogSet } = require('botbuilder-dialogs');

// Create LuisRecognizers and QnAMaker
// The LUIS applications are public, meaning you can use your own subscription key to test the applications.
// For QnAMaker, users are required to create their own knowledge base.
// The exported LUIS applications and QnAMaker knowledge base can be found with the sample bot.

// The corresponding LUIS application JSON is `dispatchSample.json`
const dispatcher = new LuisRecognizer({
    appId: '0b18ab4f-5c3d-4724-8b0b-191015b48ea9',
    subscriptionKey: process.env.LUIS_SUBSCRIPTION_KEY,
    serviceEndpoint: 'https://westus.api.cognitive.microsoft.com/',
    verbose: true
});

// The corresponding LUIS application JSON is `homeautomation.json`
const homeAutomation = new LuisRecognizer({
    appId: 'c6d161a5-e3e5-4982-8726-3ecec9b4ed8d',
    subscriptionKey: process.env.LUIS_SUBSCRIPTION_KEY,
    serviceEndpoint: 'https://westus.api.cognitive.microsoft.com/',
    verbose: true
});

// The corresponding LUIS application JSON is `weather.json`
const weather = new LuisRecognizer({
    appId: '9d0c9e9d-ce04-4257-a08a-a612955f2fb5',
    subscriptionKey: process.env.LUIS_SUBSCRIPTION_KEY,
    serviceEndpoint: 'https://westus.api.cognitive.microsoft.com/',
    verbose: true
});
```

<span data-ttu-id="4f010-247">En el código siguiente, reemplace `endpointKey` y `knowledgeBaseID` por la clave y el identificador de la base de conocimiento de QnA Maker.</span><span class="sxs-lookup"><span data-stu-id="4f010-247">In the following code, replace the `endpointKey` and `knowledgeBaseID` with your key and knowledge base ID from QnAMaker.</span></span> <span data-ttu-id="4f010-248">El `host` debe establecerse en `https://westus.api.cognitive.microsoft.com/qnamaker/v2.0` para los servicios QnA Maker de versión preliminar, y `https://YOUR-QNA-SERVICE-NAME.azurewebsites.net/qnamaker` para los servicios QnA Maker nuevos (disponibilidad general).</span><span class="sxs-lookup"><span data-stu-id="4f010-248">The `host` should be set to `https://westus.api.cognitive.microsoft.com/qnamaker/v2.0` for Preview QnA Maker services, and `https://YOUR-QNA-SERVICE-NAME.azurewebsites.net/qnamaker` for new (GA) QnA Maker services.</span></span>

```javascript
const faq = new QnAMaker(
    {
        knowledgeBaseId: '',
        endpointKey: '',
        host: ''
    },
    {
        answerBeforeNext: true
    }
);

```

<span data-ttu-id="4f010-249">El resto del código en **app.js** controla las intenciones `l_homeautomation`, `l_weather` y `None`, para lo que inicia los cuadros de diálogo pertinentes.</span><span class="sxs-lookup"><span data-stu-id="4f010-249">The rest of the code in **app.js** handles the `l_homeautomation`, `l_weather`, and `None` intents by launching appropriate dialogs.</span></span> <span data-ttu-id="4f010-250">En el caso de la intención `q_faq`, responde con la respuesta desde el servicio QnA Maker.</span><span class="sxs-lookup"><span data-stu-id="4f010-250">In the case of the `q_faq` intent, it replies with the answer from the QnAMaker service.</span></span>

> [!NOTE] 
> <span data-ttu-id="4f010-251">Si los nombres de intención `l_homeautomation`, `l_weather` o `q_faq` no coinciden con la aplicación de LUIS que ha creado mediante la herramienta de distribución, modifíquelos para que coincidan con los nombres de intención que se ven en el [portal de LUIS](https://www.luis.ai).</span><span class="sxs-lookup"><span data-stu-id="4f010-251">If the intent names `l_homeautomation`, `l_weather` or `q_faq` don't match the LUIS app you created using Dispatch, edit them to match the intent names you see in the [LUIS portal](https://www.luis.ai).</span></span>

```javascript
// create conversation state
const conversationState = new ConversationState(new MemoryStorage());
adapter.use(conversationState);

// register some dialogs for usage with the LUIS apps that are being dispatched to
const dialogs = new DialogSet();

function findEntities(entityName, entityResults) {
    let entities = []
    if (entityName in entityResults) {
        entityResults[entityName].forEach((entity, idx) => {
            entities.push(entity);
        });
    }
    return entities.length > 0 ? entities : undefined;
}

dialogs.add('HomeAutomation_TurnOff', [
    async (dialogContext, args) => {
        const devices = findEntities('HomeAutomation_Device', args.entities);
        const operations = findEntities('HomeAutomation_Operation', args.entities);

        const state = conversationState.get(dialogContext.context);
        state.homeAutomationTurnOff = state.homeAutomationTurnOff ? state.homeAutomationTurnOff + 1 : 1;
        await dialogContext.context.sendActivity(`${state.homeAutomationTurnOff}: You reached the "HomeAutomation.TurnOff" dialog.`);
        if (devices) {
            await dialogContext.context.sendActivity(`Found these "HomeAutomation_Device" entities:\n${devices.join(', ')}`);
        }
        if (operations) {
            await dialogContext.context.sendActivity(`Found these "HomeAutomation_Operation" entities:\n${operations.join(', ')}`);
        }
        await dialogContext.end();
    }
]);

dialogs.add('HomeAutomation_TurnOn', [
    async (dialogContext, args) => {
        const devices = findEntities('HomeAutomation_Device', args.entities);
        const operations = findEntities('HomeAutomation_Operation', args.entities);

        const state = conversationState.get(dialogContext.context);
        state.homeAutomationTurnOn = state.homeAutomationTurnOn ? state.homeAutomationTurnOn + 1 : 1;
        await dialogContext.context.sendActivity(`${state.homeAutomationTurnOn}: You reached the "HomeAutomation.TurnOn" dialog.`);
        if (devices) {
            await dialogContext.context.sendActivity(`Found these "HomeAutomation_Device" entities:\n${devices.join(', ')}`);
        }
        if (operations) {
            await dialogContext.context.sendActivity(`Found these "HomeAutomation_Operation" entities:\n${operations.join(', ')}`);
        }
        await dialogContext.end();
    }
]);

dialogs.add('Weather_GetForecast', [
    async (dialogContext, args) => {
        const locations = findEntities('Weather_Location', args.entities);

        const state = conversationState.get(dialogContext.context);
        state.weatherGetForecast = state.weatherGetForecast ? state.weatherGetForecast + 1 : 1;
        await dialogContext.context.sendActivity(`${state.weatherGetForecast}: You reached the "Weather.GetForecast" dialog.`);
        if (locations) {
            await dialogContext.context.sendActivity(`Found these "Weather_Location" entities:\n${locations.join(', ')}`);
        }
        await dialogContext.end();
    }
]);

dialogs.add('Weather_GetCondition', [
    async (dialogContext, args) => {
        const locations = findEntities('Weather_Location', args.entities);

        const state = conversationState.get(dialogContext.context);
        state.weatherGetCondition = state.weatherGetCondition ? state.weatherGetCondition + 1 : 1;
        await dialogContext.context.sendActivity(`${state.weatherGetCondition}: You reached the "Weather.GetCondition" dialog.`);
        if (locations) {
            await dialogContext.context.sendActivity(`Found these "Weather_Location" entities:\n${locations.join(', ')}`);
        }
        await dialogContext.end();
    }
]);

dialogs.add('None', [
    async (dialogContext) => {
        const state = conversationState.get(dialogContext.context);
        state.noneIntent = state.noneIntent ? state.noneIntent + 1 : 1;
        await dialogContext.context.sendActivity(`${state.noneIntent}: You reached the "None" dialog.`);
        await dialogContext.end();
    }
]);

adapter.use(dispatcher);

// Listen for incoming Activities
server.post('/api/messages', (req, res) => {
    adapter.processActivity(req, res, async (context) => {
        if (context.activity.type === 'message') {
            const state = conversationState.get(context);
            const dc = dialogs.createContext(context, state);

            // Retrieve the LUIS results from our dispatcher LUIS application
            const luisResults = dispatcher.get(context);

            // Extract the top intent from LUIS and use it to select which LUIS application to dispatch to
            const topIntent = LuisRecognizer.topIntent(luisResults);

            const isMessage = context.activity.type === 'message';
            if (isMessage) {
                switch (topIntent) {
                    case 'l_homeautomation':
                        const homeAutoResults = await homeAutomation.recognize(context);
                        const topHomeAutoIntent = LuisRecognizer.topIntent(homeAutoResults);
                        await dc.begin(topHomeAutoIntent, homeAutoResults);
                        break;
                    case 'l_weather':
                        const weatherResults = await weather.recognize(context);
                        const topWeatherIntent = LuisRecognizer.topIntent(weatherResults);
                        await dc.begin(topWeatherIntent, weatherResults);
                        break;
                    case 'q_faq':
                        await faq.answer(context);
                        break;
                    default:
                        await dc.begin('None');
                }
            }

            if (!context.responded) {
                await dc.continue();
                if (!context.responded && isMessage) {
                    await dc.context.sendActivity(`Hi! I'm the LUIS dispatch bot. Say something and LUIS will decide how the message should be routed.`);
                }
            }
        }
    });
});

```

---
## <a name="run-the-bot"></a><span data-ttu-id="4f010-252">Ejecutar el bot</span><span class="sxs-lookup"><span data-stu-id="4f010-252">Run the bot</span></span>

<span data-ttu-id="4f010-253">Pruebe el bot con [Bot Framework Emulator](../bot-service-debug-emulator.md).</span><span class="sxs-lookup"><span data-stu-id="4f010-253">Test out the bot using the [Bot Framework Emulator](../bot-service-debug-emulator.md).</span></span> <span data-ttu-id="4f010-254">Envíele un mensaje como "encender las luces" para distribuir el mensaje a la aplicación de LUIS de automatización del hogar, y un mensaje como "consultar la información meteorológica en Seattle" para enviarlo a la aplicación de LUIS de información meteorológica.</span><span class="sxs-lookup"><span data-stu-id="4f010-254">Send it messages like "turn on the lights" to dispatch the message to the home automation LUIS app, and send it messages like "get the weather in Seattle" to dispatch to the weather LUIS app.</span></span>

> [!NOTE] 
> <span data-ttu-id="4f010-255">Antes de ejecutar el bot, asegúrese de que ha publicado todas las aplicaciones LUIS que ha creado en el [portal de LUIS](https://www.luis.ai) y compruebe que ha publicado el servicio QnA Maker en el [portal de QnA Maker](https://qnamaker.ai).</span><span class="sxs-lookup"><span data-stu-id="4f010-255">Before you run the bot, make sure you have published all the LUIS apps that you created in the [LUIS portal](https://www.luis.ai), and check that you've published the QnA Maker service in the [QnA Maker portal](https://qnamaker.ai).</span></span>

![Enviar mensajes al bot de distribución](media/tutorial-dispatch/run-dispatch-bot.png)

## <a name="evaluate-the-dispatchers-performance"></a><span data-ttu-id="4f010-257">Evaluar el rendimiento del distribuidor</span><span class="sxs-lookup"><span data-stu-id="4f010-257">Evaluate the dispatcher's performance</span></span>

<span data-ttu-id="4f010-258">Algunos mensajes de usuario se proporcionan como ejemplos en las aplicaciones de LUIS y los servicios QnA Maker, y la aplicación de LUIS combinada que la herramienta de distribución genera no funcionará bien para esas entradas.</span><span class="sxs-lookup"><span data-stu-id="4f010-258">Sometimes there are user messages that are provided as examples in both the LUIS apps and the QnA maker services, and the combined LUIS app that Dispatch generates won't perform well for those inputs.</span></span> <span data-ttu-id="4f010-259">Para comprobar el rendimiento de su aplicación, use la opción `eval`.</span><span class="sxs-lookup"><span data-stu-id="4f010-259">Check your app's performance using the `eval` option.</span></span> 

```
dispatch eval
```

<span data-ttu-id="4f010-260">Al ejecutar `dispatch eval` se genera un archivo **Summary.html** que proporciona estadísticas sobre el rendimiento del nuevo modelo de lenguaje.</span><span class="sxs-lookup"><span data-stu-id="4f010-260">Running `dispatch eval` generates a **Summary.html** file that provides statistics on the performance of the new language model.</span></span>

> [!TIP] 
> <span data-ttu-id="4f010-261">Puede ejecutar `dispatch eval` en cualquier aplicación de LUIS, no solo en las aplicaciones de LUIS que ha creado la herramienta de distribución.</span><span class="sxs-lookup"><span data-stu-id="4f010-261">You can actually run `dispatch eval` on any LUIS app, not just LUIS apps created by the dispatch tool.</span></span>

### <a name="edit-intents-for-duplicates-and-overlaps"></a><span data-ttu-id="4f010-262">Editar las intenciones para los duplicados y las superposiciones</span><span class="sxs-lookup"><span data-stu-id="4f010-262">Edit intents for duplicates and overlaps</span></span>

<span data-ttu-id="4f010-263">Revise las expresiones de ejemplo marcadas como duplicados en **Summary.html** y quite los ejemplos similares o que se superponen.</span><span class="sxs-lookup"><span data-stu-id="4f010-263">Review example utterances that are flagged as duplicates in **Summary.html**, and remove similar or overlapping examples.</span></span> <span data-ttu-id="4f010-264">Por ejemplo, supongamos que en la aplicación de LUIS `homeautomation` para la automatización del hogar, las solicitudes como "encender las luces" se asignan a una intención "TurnOnLights", pero las solicitudes como "¿Por qué no se encienden las luces?"</span><span class="sxs-lookup"><span data-stu-id="4f010-264">For example, let's say that in the `homeautomation` LUIS app for homeautomation, requests like "turn my lights on" map to a "TurnOnLights" intent, but requests like "Why won't my lights turn on?"</span></span> <span data-ttu-id="4f010-265">se asignan a una intención "None" para que se puedan pasar a QnA Maker.</span><span class="sxs-lookup"><span data-stu-id="4f010-265">map to a "None" intent so that they can be passed on to QnA maker.</span></span> <span data-ttu-id="4f010-266">Al combinar la aplicación de LUIS y el servicio QnA Maker mediante la herramienta de distribución, es preciso llevar a cabo una de las acciones siguientes:</span><span class="sxs-lookup"><span data-stu-id="4f010-266">When you combine the LUIS app and the QnA maker service using dispatch, you need to do one of the following:</span></span> 

* <span data-ttu-id="4f010-267">Quitar la intención "None" de la aplicación de LUIS `homeautomation` original y agregar las expresiones de dicha intención a la intención "None" de la aplicación de distribuidor.</span><span class="sxs-lookup"><span data-stu-id="4f010-267">Remove the "None" intent from the original `homeautomation` LUIS app, and add the utterances in that intent to the "None" intent in the dispatcher app.</span></span>
* <span data-ttu-id="4f010-268">Si no quita la intención "None" de la aplicación de LUIS original, deberá agregar lógica en su bot para pasar los mensajes que coinciden con dicha intención al servicio QnA Maker.</span><span class="sxs-lookup"><span data-stu-id="4f010-268">If you don't remove the "None" intent from the original LUIS app, you need to add logic in your bot to pass those messages that match that intent on to the QnA maker service.</span></span>

> [!TIP] 
> <span data-ttu-id="4f010-269">Vea [Best practices for Language Understanding](./bot-builder-concept-luis.md#best-practices-for-language-understanding) (Procedimientos recomendados para Language Understanding) para obtener sugerencias sobre cómo mejorar el rendimiento del modelo de lenguaje.</span><span class="sxs-lookup"><span data-stu-id="4f010-269">Review [Best practices for Language Understanding](./bot-builder-concept-luis.md#best-practices-for-language-understanding) for tips on improving your language model's performance.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="4f010-270">Recursos adicionales</span><span class="sxs-lookup"><span data-stu-id="4f010-270">Additional resources</span></span>

* <span data-ttu-id="4f010-271">[Uso de LUIS para el flujo de conversación][luis-v4-how-to]</span><span class="sxs-lookup"><span data-stu-id="4f010-271">[Using LUIS for conversation flow][luis-v4-how-to]</span></span>

[luis-v4-how-to]: bot-builder-howto-v4-luis.md
<!-- links -->

[HomeAutomationJSON]: https://aka.ms/dispatch-luis1
[WeatherJSON]: https://aka.ms/dispatch-luis2
[DispatchJSON]: https://aka.ms/dispatch-luis
[FAQ_TSV]: https://aka.ms/dispatch-qna-tsv

[DispatchTool]: https://github.com/Microsoft/botbuilder-tools/tree/master/Dispatch
[DispatchBotCS]: https://aka.ms/dispatch-sample-cs
[DispatchBotJs]: https://aka.ms/dispatch-sample-js



