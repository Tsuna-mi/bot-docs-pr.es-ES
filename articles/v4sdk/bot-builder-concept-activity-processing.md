---
title: Procesamiento de actividades | Microsoft Docs
description: Descripción del procesamiento de actividades en el SDK del bot.
keywords: adaptador de bot, software intermedio personalizado, cortocircuito, reserva, controladores de eventos
author: jonathanfingold
ms.author: jonathanfingold
manager: kamrani
ms.topic: article
ms.prod: bot-framework
ms.date: 03/22/2018
monikerRange: azure-bot-service-4.0
ms.openlocfilehash: 8e08ac4721ee78bbd5d13dac09d9e505d3a1b134
ms.sourcegitcommit: f95702d27abbd242c902eeb218d55a72df56ce56
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 07/19/2018
ms.locfileid: "39306492"
---
# <a name="activity-processing"></a><span data-ttu-id="8c07f-104">Procesamiento de actividades</span><span class="sxs-lookup"><span data-stu-id="8c07f-104">Activity processing</span></span>

[!INCLUDE [pre-release-label](~/includes/pre-release-label.md)]

<span data-ttu-id="8c07f-105">El bot y el usuario intercambian información a través de actividades.</span><span class="sxs-lookup"><span data-stu-id="8c07f-105">The bot and user exchange information via activities.</span></span> <span data-ttu-id="8c07f-106">Cada una de las actividades que recibe la aplicación de bot se pasa a un adaptador de bot, que a su vez pasa la información de la actividad a la lógica del bot y, por último, envía las respuestas al usuario.</span><span class="sxs-lookup"><span data-stu-id="8c07f-106">Each activity received by your bot application is passed to a bot adapter, which passes activity information to your bot logic and ultimately sends any responses to the user.</span></span>

[!INCLUDE [Define a turn](~/includes/snippet-definition-turn.md)]

> [!IMPORTANT]
> <span data-ttu-id="8c07f-107">Las actividades, especialmente las que [generamos](#generating-responses) durante un turno de bot, se administran de forma asincrónica.</span><span class="sxs-lookup"><span data-stu-id="8c07f-107">Activities, particularly those that [we generate](#generating-responses) during a bot turn, are handled asynchronously.</span></span> <span data-ttu-id="8c07f-108">Se trata de una parte necesaria de la creación de un bot; si necesita repasar cómo funciona todo esto, vea [Programación asincrónica para .NET](https://docs.microsoft.com/en-us/dotnet/csharp/async) o [async para JavaScript](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function), según el lenguaje que haya elegido.</span><span class="sxs-lookup"><span data-stu-id="8c07f-108">It's a necessary part of building a bot; if you need to brush up on how that all works, check out [async for .NET](https://docs.microsoft.com/en-us/dotnet/csharp/async) or [async for JavaScript](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function) depending on your language choice.</span></span>

## <a name="the-bot-adapter"></a><span data-ttu-id="8c07f-109">El adaptador de bot</span><span class="sxs-lookup"><span data-stu-id="8c07f-109">The bot adapter</span></span>

<span data-ttu-id="8c07f-110">Un bot está dirigido por su **adaptador**, que podría considerarse como el director del bot.</span><span class="sxs-lookup"><span data-stu-id="8c07f-110">A bot is directed by its **adapter**, which can be thought of as the conductor for your bot.</span></span> <span data-ttu-id="8c07f-111">El adaptador se encarga de la autenticación, el enrutamiento de la comunicación entrante y saliente, etc.</span><span class="sxs-lookup"><span data-stu-id="8c07f-111">The adapter is responsible for authentication, the routing of incoming and outgoing communication, and so on.</span></span> <span data-ttu-id="8c07f-112">El adaptador difiere en función de su entorno (es decir, internamente funciona de forma diferente en un entorno local y en Azure), pero en cada instancia se ocupa del mismo objetivo.</span><span class="sxs-lookup"><span data-stu-id="8c07f-112">The adapter differs based on it's environment (the adapter internally works differently locally versus on Azure) but in each instance it achieves the same goal.</span></span> <span data-ttu-id="8c07f-113">En la mayoría de los casos no trabajamos con el adaptador directamente (por ejemplo, al crear un bot a partir de una plantilla), pero no está de más saber dónde se encuentra y qué hace.</span><span class="sxs-lookup"><span data-stu-id="8c07f-113">In most situations we don't work with the adapter directly, such as when creating a bot from a template, but it's good to know it's there and what it does.</span></span>

<span data-ttu-id="8c07f-114">El adaptador de bot encapsula los procesos de autenticación, envía actividades a Bot Connector Service y recibe actividades de este.</span><span class="sxs-lookup"><span data-stu-id="8c07f-114">The bot adapter encapsulates authentication processes and sends activities to and receives activities from the Bot Connector Service.</span></span> <span data-ttu-id="8c07f-115">Cuando el bot recibe una actividad, el adaptador encapsula todo lo relativo a esa actividad, crea un [objeto de contexto](#turn-context) para el turno, lo pasa a la lógica de aplicación del bot y envía las respuestas que genera el bot al canal del usuario.</span><span class="sxs-lookup"><span data-stu-id="8c07f-115">When your bot receives an activity, the adapter wraps up everything about that activity, creates a [context object](#turn-context) for the turn, passes it to your bot's application logic, and sends responses generated by your bot back to the user's channel.</span></span>

## <a name="authentication"></a><span data-ttu-id="8c07f-116">Autenticación</span><span class="sxs-lookup"><span data-stu-id="8c07f-116">Authentication</span></span>

<span data-ttu-id="8c07f-117">El adaptador autentica todas las actividades entrantes que recibe la aplicación mediante la información de la actividad y el encabezado `Authentication` de la solicitud de REST.</span><span class="sxs-lookup"><span data-stu-id="8c07f-117">The adapter authenticates each incoming activity the application receives, using information from the activity and the `Authentication` header from the REST request.</span></span>

<span data-ttu-id="8c07f-118">El adaptador usa un objeto de conector y las credenciales de la aplicación para autenticar las actividades de salida con destino al usuario.</span><span class="sxs-lookup"><span data-stu-id="8c07f-118">The adapter uses a connector object and your application's credentials to authenticate the outbound activities to the user.</span></span>

<span data-ttu-id="8c07f-119">La autenticación de Bot Connector Service usa tokens `Bearer` de JWT (JSON Web Token), así como el **identificador de aplicación de Microsoft** y la **contraseña de aplicación de Microsoft** que Azure genera automáticamente cuando se crea un servicio de bot o se registra un bot.</span><span class="sxs-lookup"><span data-stu-id="8c07f-119">Bot Connector Service authentication uses JWT (JSON Web Token) `Bearer` tokens and the **Microsoft app ID** and **Microsoft app password** that Azure creates for you when you create a bot service or register your bot.</span></span> <span data-ttu-id="8c07f-120">La aplicación necesitará estas credenciales en el tiempo de inicialización para permitir que el adaptador autentique el tráfico.</span><span class="sxs-lookup"><span data-stu-id="8c07f-120">Your application will need these credentials at initialization time, to allow the adapter to authenticate traffic.</span></span>

> [!NOTE]
> <span data-ttu-id="8c07f-121">Si está ejecutando o probando el bot localmente (por ejemplo, mediante Bot Framework Emulator), puede hacerlo sin configurar el adaptador para autenticar el tráfico hacia y desde el bot.</span><span class="sxs-lookup"><span data-stu-id="8c07f-121">If you are running or testing your bot locally, for example, using the Bot Framework Emulator, you can do so without configuring the adapter to authenticate traffic to and from your bot.</span></span>

## <a name="turn-context"></a><span data-ttu-id="8c07f-122">Contexto de turno</span><span class="sxs-lookup"><span data-stu-id="8c07f-122">Turn context</span></span>

<span data-ttu-id="8c07f-123">Cuando un adaptador recibe una actividad, genera un objeto de **contexto de turno**, que proporciona información sobre la actividad entrante, el remitente, el receptor, el canal, la conversación y otros datos necesarios para procesar la actividad.</span><span class="sxs-lookup"><span data-stu-id="8c07f-123">When an adapter receives an activity, it generates a **turn context** object, which provides information about the incoming activity, the sender and receiver, the channel, the conversation, and other data needed to process the activity.</span></span> <span data-ttu-id="8c07f-124">Después, el adaptador pasa este objeto de contexto al bot.</span><span class="sxs-lookup"><span data-stu-id="8c07f-124">The adapter then passes this context object to the bot.</span></span> <span data-ttu-id="8c07f-125">El objeto de contexto se conserva mientras dure el turno y proporciona información sobre lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="8c07f-125">The context object persists for the length of a turn, and provides information on the following:</span></span>

* <span data-ttu-id="8c07f-126">Conversación: identifica la conversación e incluye información sobre el bot y el usuario que participan en la conversación.</span><span class="sxs-lookup"><span data-stu-id="8c07f-126">Conversation - Identifies the conversation and includes information about the bot and the user participating in the conversation.</span></span>
* <span data-ttu-id="8c07f-127">Actividad: las solicitudes y las respuestas de una conversación son los tipos de actividades.</span><span class="sxs-lookup"><span data-stu-id="8c07f-127">Activity - The requests and replies in a conversation are all types of activities.</span></span> <span data-ttu-id="8c07f-128">Este contexto proporciona información sobre la actividad entrante, incluida la información de enrutamiento, la información sobre el canal, la conversación, el remitente y el receptor.</span><span class="sxs-lookup"><span data-stu-id="8c07f-128">This context provides information about the incoming activity, including routing information, information about the channel, the conversation, the sender, and the receiver.</span></span>
* <span data-ttu-id="8c07f-129">Estado: propiedades que se usan para llevar un seguimiento de su [estado](~/v4sdk/bot-builder-storage-concept.md), por ejemplo, dónde se encuentra en una conversación con un usuario, información sobre el usuario u otra información de la lógica de negocios.</span><span class="sxs-lookup"><span data-stu-id="8c07f-129">State - Properties used to keep track of its [state](~/v4sdk/bot-builder-storage-concept.md), such as where it is in a conversation with a user, information about that user, or other business-logic information.</span></span>
* <span data-ttu-id="8c07f-130">Información personalizada: si extiende el bot mediante la implementación de software intermedio o dentro de la lógica del bot, puede hacer que haya información adicional disponible en cada turno.</span><span class="sxs-lookup"><span data-stu-id="8c07f-130">Custom information – If you extend your bot either by implementing middleware or within your bot logic, you can make additional information available in each turn.</span></span>

<span data-ttu-id="8c07f-131">El objeto de contexto también puede usarse para enviar una respuesta al usuario y obtener una referencia al adaptador para crear una conversación o continuar con una ya existente.</span><span class="sxs-lookup"><span data-stu-id="8c07f-131">The context object can also be used to send a response to the user, and get a reference to the adapter to create a new conversation or continue an existing one.</span></span>

> [!NOTE]
> <span data-ttu-id="8c07f-132">La aplicación y el adaptador controlarán las solicitudes de forma asincrónica, pero no es necesario que la lógica de negocios esté controlada por la solicitud-respuesta.</span><span class="sxs-lookup"><span data-stu-id="8c07f-132">Your application and the adapter will handle requests asynchronously; however, your business logic does not need to be request-response driven.</span></span>

## <a name="middleware"></a><span data-ttu-id="8c07f-133">Software intermedio</span><span class="sxs-lookup"><span data-stu-id="8c07f-133">Middleware</span></span>

<span data-ttu-id="8c07f-134">Puede agregar software intermedio al adaptador.</span><span class="sxs-lookup"><span data-stu-id="8c07f-134">You can add middleware to the adapter.</span></span> <span data-ttu-id="8c07f-135">El software intermedio consiste en capas de complementos que se agregan al bot y a la lógica básica del bot.</span><span class="sxs-lookup"><span data-stu-id="8c07f-135">Middleware are layers of plug-ins added to your bot and your core bot logic.</span></span> <span data-ttu-id="8c07f-136">Para información más detallada sobre el software intermedio, vea el [artículo independiente sobre el software intermedio](~/v4sdk/bot-builder-concept-middleware.md).</span><span class="sxs-lookup"><span data-stu-id="8c07f-136">For more in depth information about middleware, see the independent [middleware article](~/v4sdk/bot-builder-concept-middleware.md).</span></span>

<span data-ttu-id="8c07f-137">El software intermedio y la lógica del bot usan el objeto de contexto para recuperar información sobre la actividad y actuar en consecuencia.</span><span class="sxs-lookup"><span data-stu-id="8c07f-137">The middleware and the bot logic use the context object to retrieve information about the activity and act accordingly.</span></span> <span data-ttu-id="8c07f-138">El software intermedio y el bot también pueden actualizar o agregar información al objeto de contexto, por ejemplo, para llevar un seguimiento del estado de un turno, una conversación u otro ámbito.</span><span class="sxs-lookup"><span data-stu-id="8c07f-138">The middleware and the bot can also update or add information to the context object, such as to track state for a turn, a conversation, or other scope.</span></span> <span data-ttu-id="8c07f-139">El SDK proporciona _software intermedio de estado_ que se puede usar para agregar persistencia de estado al bot.</span><span class="sxs-lookup"><span data-stu-id="8c07f-139">The SDK provides some _state middleware_ that you can use to add state persistence to your bot.</span></span>

## <a name="generating-responses"></a><span data-ttu-id="8c07f-140">Generación de respuestas</span><span class="sxs-lookup"><span data-stu-id="8c07f-140">Generating responses</span></span>

<span data-ttu-id="8c07f-141">El objeto de contexto proporciona métodos de respuesta de actividad para permitir que el código responda a una actividad:</span><span class="sxs-lookup"><span data-stu-id="8c07f-141">The context object provides activity response methods to allow code to respond to an activity:</span></span>

* <span data-ttu-id="8c07f-142">Los métodos _send activity_ y _send activities_ envían una o más actividades a la conversación.</span><span class="sxs-lookup"><span data-stu-id="8c07f-142">The _send activity_ and _send activities_ methods sends one or more activities to the conversation.</span></span>
* <span data-ttu-id="8c07f-143">Si el canal lo admite, el método _update activity_ actualiza una actividad de la conversación.</span><span class="sxs-lookup"><span data-stu-id="8c07f-143">If supported by the channel, the _update activity_ method updates an activity within the conversation.</span></span>
* <span data-ttu-id="8c07f-144">Si el canal lo admite, el método _delete activity_ elimina una actividad de la conversación.</span><span class="sxs-lookup"><span data-stu-id="8c07f-144">If supported by the channel, the _delete activity_ method removes an activity from the conversation.</span></span>

<span data-ttu-id="8c07f-145">Cada método de respuesta se ejecuta en un proceso asincrónico.</span><span class="sxs-lookup"><span data-stu-id="8c07f-145">Each response method runs in an asynchronous process.</span></span> <span data-ttu-id="8c07f-146">Cuando se llama al método de respuesta de actividad, este clona la lista de controladores de eventos asociados antes de empezar a llamar a los controladores, lo que significa que contendrá todos los controladores agregados hasta ese momento, pero no contendrá nada de lo que se agregue una vez iniciado el proceso.</span><span class="sxs-lookup"><span data-stu-id="8c07f-146">When it is called, the activity response method clones the associated event handler list before starting to call the handlers, which means it will contain every handler added up to this point but will not contain anything added after the process starts.</span></span>

<span data-ttu-id="8c07f-147">Esto también significa que no se garantiza el orden de las respuestas, sobre todo cuando una tarea es más compleja que otra.</span><span class="sxs-lookup"><span data-stu-id="8c07f-147">This also means the order of your responses is not guaranteed, particularly when one task is more complex than another.</span></span> <span data-ttu-id="8c07f-148">Si el bot puede generar varias respuestas para una actividad entrante, asegúrese de que tienen sentido en cualquier orden en el que las reciba el usuario.</span><span class="sxs-lookup"><span data-stu-id="8c07f-148">If your bot can generate multiple responses to an incoming activity, make sure that they make sense in whatever order they are received by the user.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="8c07f-149">El subproceso que administra el turno de bot principal se ocupa de desechar el objeto de contexto cuando termina.</span><span class="sxs-lookup"><span data-stu-id="8c07f-149">The thread handling the primary bot turn deals with disposing of the context object when it is done.</span></span> <span data-ttu-id="8c07f-150">Si una respuesta (incluidos sus controladores) tarda mucho e intenta actuar sobre el objeto de contexto, es posible que reciba un error `Context was disposed`.</span><span class="sxs-lookup"><span data-stu-id="8c07f-150">If a response (including its handlers) take any significant amount of time and try to act on the context object, they may get a `Context was disposed` error.</span></span> <span data-ttu-id="8c07f-151">**Asegúrese de usar `await` para las llamadas de actividad**, a fin de que el subproceso principal espere la actividad generada antes de finalizar su procesamiento y desechar el contexto de turno.</span><span class="sxs-lookup"><span data-stu-id="8c07f-151">**Be sure to `await` any activity calls** so the primary thread will wait on the generated activity before finishing it's processing and disposing of the turn context.</span></span>

## <a name="response-event-handlers"></a><span data-ttu-id="8c07f-152">Controladores de eventos de respuesta</span><span class="sxs-lookup"><span data-stu-id="8c07f-152">Response event handlers</span></span>

<span data-ttu-id="8c07f-153">Además de la lógica del bot y del software intermedio, se pueden agregar controladores de respuesta (a veces denominados controladores de eventos o controladores de eventos de actividad) al objeto de contexto.</span><span class="sxs-lookup"><span data-stu-id="8c07f-153">In addition to the bot and middleware logic, response handlers (also sometimes referred to as event handlers, or activity event handlers) can be added to the context object.</span></span> <span data-ttu-id="8c07f-154">Se llama a estos controladores cuando la respuesta asociada se produce en el objeto de contexto actual, antes de ejecutar la respuesta real.</span><span class="sxs-lookup"><span data-stu-id="8c07f-154">These handlers are called when the associated response happens on the current context object, before executing the actual response.</span></span> <span data-ttu-id="8c07f-155">Estos controladores son útiles si sabe que querrá hacer algo, ya sea antes o después del evento real, para todas las actividades de ese tipo durante el resto de la respuesta actual.</span><span class="sxs-lookup"><span data-stu-id="8c07f-155">These handlers are useful when you know you'll want to do something, either before or after the actual event, for every activity of that type for the rest of the current response.</span></span>

> [!WARNING]
> <span data-ttu-id="8c07f-156">Tenga cuidado de no llamar a un método de respuesta de actividad desde su controlador de eventos de respuesta correspondiente, por ejemplo, mediante una llamada al método de actividad de envío desde un controlador _on send activity_.</span><span class="sxs-lookup"><span data-stu-id="8c07f-156">Be careful to not call an activity response method from within it's respective response event handler, for example, calling the send activity method from within an _on send activity_ handler.</span></span> <span data-ttu-id="8c07f-157">Si lo hace, puede generar un bucle infinito.</span><span class="sxs-lookup"><span data-stu-id="8c07f-157">Doing so can generate an infinite loop.</span></span>

<span data-ttu-id="8c07f-158">Cada actividad nueva obtiene un nuevo subproceso en el que se ejecuta.</span><span class="sxs-lookup"><span data-stu-id="8c07f-158">Each new activity gets a new thread to execute on.</span></span> <span data-ttu-id="8c07f-159">Cuando se crea el subproceso para procesar la actividad, la lista de controladores de esa actividad se copia en ese subproceso nuevo.</span><span class="sxs-lookup"><span data-stu-id="8c07f-159">When the thread to process the activity is created, the list of handlers for that activity is copied to that new thread.</span></span> <span data-ttu-id="8c07f-160">No se ejecutará para ese evento de actividad específico ningún controlador agregado después de ese punto.</span><span class="sxs-lookup"><span data-stu-id="8c07f-160">No handlers added after that point will be executed for that specific activity event.</span></span>

<span data-ttu-id="8c07f-161">El adaptador administra los controladores registrados en un objeto de contexto de forma muy similar al modo en que administra la [canalización de software intermedio](~/v4sdk/bot-builder-concept-middleware.md#the-bot-middleware-pipeline).</span><span class="sxs-lookup"><span data-stu-id="8c07f-161">The adapter manages the handlers registered on a context object very similarly to how it manages the [middleware pipeline](~/v4sdk/bot-builder-concept-middleware.md#the-bot-middleware-pipeline).</span></span>

<span data-ttu-id="8c07f-162">Es decir, se llama a los controladores en el orden en que se agregan, y al llamar al delegado _next_ se pasa el control al siguiente controlador de eventos registrado.</span><span class="sxs-lookup"><span data-stu-id="8c07f-162">Namely, handlers get called in the order they're added, and calling the _next_ delegate passes control to the next registered event handler.</span></span> <span data-ttu-id="8c07f-163">Si un controlador no llama al delegado next, el adaptador no llama a ninguno de los controladores de eventos posteriores; se produce un [cortocircuito](~/v4sdk/bot-builder-concept-middleware.md#short-circuiting) en el evento y el adaptador no envía la respuesta al canal.</span><span class="sxs-lookup"><span data-stu-id="8c07f-163">If a handler doesn’t call the next delegate, the adapter does not call any of the subsequent event handlers; the event [short circuits](~/v4sdk/bot-builder-concept-middleware.md#short-circuiting), and the adapter does not send the response to the channel.</span></span>

## <a name="next-steps"></a><span data-ttu-id="8c07f-164">Pasos siguientes</span><span class="sxs-lookup"><span data-stu-id="8c07f-164">Next steps</span></span>

<span data-ttu-id="8c07f-165">Ahora que está familiarizado con algunos conceptos clave de un bot, vamos a profundizar en la manera en que un bot puede enviar mensajes proactivos.</span><span class="sxs-lookup"><span data-stu-id="8c07f-165">Now that you're familiar with some key concepts of a bot, let's dive into the details of how a bot can send proactive messages.</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="8c07f-166">Software intermedio</span><span class="sxs-lookup"><span data-stu-id="8c07f-166">Middleware</span></span>](~/v4sdk/bot-builder-concept-middleware.md)
