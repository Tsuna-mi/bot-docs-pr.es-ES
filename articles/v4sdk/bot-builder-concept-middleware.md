---
title: Software intermedio | Microsoft Docs
description: Descripción del software intermedio y de sus usos en el SDK del bot.
keywords: software intermedio, canalización de software intermedio, cortocircuito, usos del software intermedio
author: ivorb
ms.author: v-ivorb
manager: kamrani
ms.topic: article
ms.prod: bot-framework
ms.date: 05/24/2018
monikerRange: azure-bot-service-4.0
ms.openlocfilehash: d8201da0fb406f30888dfaa4ff6017f125990104
ms.sourcegitcommit: 2dc75701b169d822c9499e393439161bc87639d2
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 08/24/2018
ms.locfileid: "42905379"
---
# <a name="middleware"></a><span data-ttu-id="8e30f-104">Software intermedio</span><span class="sxs-lookup"><span data-stu-id="8e30f-104">Middleware</span></span>

[!INCLUDE [pre-release-label](../includes/pre-release-label.md)]

<span data-ttu-id="8e30f-105">El software intermedio es simplemente una clase que se encuentra entre el adaptador y la lógica del bot, que se agrega a la colección de software intermedio del adaptador durante la inicialización.</span><span class="sxs-lookup"><span data-stu-id="8e30f-105">Middleware is simply a class that sits between the adapter and your bot logic, added to your adapter's middleware collection during initialization.</span></span> <span data-ttu-id="8e30f-106">El SDK le permite escribir su propio software intermedio o agregar componentes reutilizables de software intermedio creado por otros usuarios.</span><span class="sxs-lookup"><span data-stu-id="8e30f-106">The SDK allows you to write your own middleware or add reusable components of middleware created by others.</span></span> <span data-ttu-id="8e30f-107">¿Qué se puede hacer en el software intermedio?</span><span class="sxs-lookup"><span data-stu-id="8e30f-107">What can you do in middleware?</span></span> <span data-ttu-id="8e30f-108">Prácticamente de todo. Todas las actividades que entran y salen de su bot fluyen a través del software intermedio.</span><span class="sxs-lookup"><span data-stu-id="8e30f-108">Just about anything... Every activity coming into or out of your bot flows through middleware.</span></span>

<span data-ttu-id="8e30f-109">El adaptador procesa y dirige las actividades entrantes a través de la canalización de software intermedio del bot a la lógica del bot y, luego, otra vez de vuelta.</span><span class="sxs-lookup"><span data-stu-id="8e30f-109">The adapter processes and directs incoming activities in through the bot middleware pipeline to your bot’s logic and then back out again.</span></span> <span data-ttu-id="8e30f-110">Cuando las actividades entran y salen de los bots, cada fragmento de software intermedio puede inspeccionar o actuar sobre la actividad, tanto antes como después de que se ejecute la lógica del bot.</span><span class="sxs-lookup"><span data-stu-id="8e30f-110">As each activity flows in and out of the bot, each piece of middleware can inspect or act upon the activity, both before and after the bot logic runs.</span></span>

<span data-ttu-id="8e30f-111">Antes de centrarse en el software intermedio, es importante entender los [bots en general](~/v4sdk/bot-builder-basics.md) y [cómo procesan las actividades](~/v4sdk/bot-builder-concept-activity-processing.md).</span><span class="sxs-lookup"><span data-stu-id="8e30f-111">Before jumping into middleware, it is important to understand [bots in general](~/v4sdk/bot-builder-basics.md) and [how they process activities](~/v4sdk/bot-builder-concept-activity-processing.md).</span></span>

## <a name="uses-for-middleware"></a><span data-ttu-id="8e30f-112">Usos del software intermedio</span><span class="sxs-lookup"><span data-stu-id="8e30f-112">Uses for middleware</span></span>

<span data-ttu-id="8e30f-113">A menudo, los usuarios se preguntan qué debe ir en el software intermedio en lugar de en la lógica del bot.</span><span class="sxs-lookup"><span data-stu-id="8e30f-113">The question that often comes up: what should go in middleware versus your bot logic?</span></span> <span data-ttu-id="8e30f-114">El software intermedio es bastante flexible, por lo que en última instancia, esto depende de usted.</span><span class="sxs-lookup"><span data-stu-id="8e30f-114">Middleware is pretty flexible, so ultimately that is up to you.</span></span> <span data-ttu-id="8e30f-115">Veamos un par de usos en los que el software intermedio resulta ideal.</span><span class="sxs-lookup"><span data-stu-id="8e30f-115">Let's cover a couple of good uses for middleware.</span></span>

### <a name="looking-at-or-acting-on-every-activity"></a><span data-ttu-id="8e30f-116">Registrar o actuar sobre todas las actividades</span><span class="sxs-lookup"><span data-stu-id="8e30f-116">Looking at or acting on every activity</span></span>

<span data-ttu-id="8e30f-117">Existen muchas situaciones que requieren que nuestro bot haga algo en todas las actividades, o bien en todas las actividades de un tipo determinado.</span><span class="sxs-lookup"><span data-stu-id="8e30f-117">There are plenty of situations that require our bot to do something on every activity, or for every activity of a certain type.</span></span> <span data-ttu-id="8e30f-118">Por ejemplo, tal vez nos interese registrar todas las actividades de mensajes que recibe el bot, o proporcionar una respuesta de reserva si el bot no ha generado ninguna respuesta en este turno.</span><span class="sxs-lookup"><span data-stu-id="8e30f-118">For example, we may want to log every message activity our bot receives, or provide a fallback response if the bot has not otherwise generated a response this turn.</span></span> <span data-ttu-id="8e30f-119">El software intermedio es idóneo para hacerlo, ya que puede actuar tanto antes como después de que se haya ejecutado el resto de la lógica del bot.</span><span class="sxs-lookup"><span data-stu-id="8e30f-119">Middleware is a great place for this, with its ability to act both before and after the rest of the bot logic has executed.</span></span>

### <a name="modifying-or-enhancing-the-turn-context"></a><span data-ttu-id="8e30f-120">Modificar o mejorar el contexto de turno</span><span class="sxs-lookup"><span data-stu-id="8e30f-120">Modifying or enhancing the turn context</span></span>

<span data-ttu-id="8e30f-121">Algunas conversaciones pueden ser mucho más provechosas si el bot tiene más información de la que se proporciona en la actividad.</span><span class="sxs-lookup"><span data-stu-id="8e30f-121">Certain conversations can be much more fruitful if the bot has more information than what is provided in the activity.</span></span> <span data-ttu-id="8e30f-122">En este caso, el middleware podría comprobar la información de estado de la conversación que se tiene hasta el momento, consultar un origen de datos externo y anexarlo al objeto del [contexto de turno](bot-builder-concept-activity-processing.md#turn-context) antes de pasar la ejecución a la lógica del bot.</span><span class="sxs-lookup"><span data-stu-id="8e30f-122">Middleware in this case could look at the conversation state information it has so far, query an external data source, and append that to the [turn context](bot-builder-concept-activity-processing.md#turn-context) object before passing execution on to the bot logic.</span></span>
<span data-ttu-id="8e30f-123">Por ejemplo, el software intermedio podría identificar los detalles de la conversación, como el identificador de conversación y el estado, y consultar un servicio de directorio para obtener información.</span><span class="sxs-lookup"><span data-stu-id="8e30f-123">For example, middleware could identify the conversation details, such as the conversation ID and state, and then query a directory service for information.</span></span> <span data-ttu-id="8e30f-124">También podría agregar el objeto de usuario que se recibe de esa consulta externa al objeto de contexto y pasarlo, con lo que proporciona más datos sobre el usuario y permite que el bot controle mejor la solicitud.</span><span class="sxs-lookup"><span data-stu-id="8e30f-124">The middleware could add the user object received from that external query to the context object and pass it on, providing more data about the user and allowing the bot to better handle the request.</span></span>

<span data-ttu-id="8e30f-125">El software intermedio puede usarse para las dos finalidades anteriores, o bien para otra completamente diferente; todo depende de cómo quiera que se estructure el bot y de lo que el bot intente conseguir.</span><span class="sxs-lookup"><span data-stu-id="8e30f-125">Middleware may fall into both of the uses above, or into another use completely; it all depends on how you want your bot to be structured and what your bot is trying to achieve.</span></span>
<span data-ttu-id="8e30f-126">El software intermedio puede establecer o conservar un estado, reaccionar a las solicitudes entrantes o producir un cortocircuito en la canalización.</span><span class="sxs-lookup"><span data-stu-id="8e30f-126">Middleware can establish or persist state, react to incoming requests, or short circuit the pipeline.</span></span>
<span data-ttu-id="8e30f-127">Entre los candidatos para el software intermedio, se incluyen los siguientes:</span><span class="sxs-lookup"><span data-stu-id="8e30f-127">Some candidates for middleware include:</span></span>

- <span data-ttu-id="8e30f-128">**almacenamiento o persistencia**: use software intermedio para almacenar o conservar valores después de un turno, o bien para actualizar un valor según lo que haya ocurrido en ese turno.</span><span class="sxs-lookup"><span data-stu-id="8e30f-128">**storage or persistence**: Use middleware to store or persist values after a turn, or update some value based off what happened that turn.</span></span>
- <span data-ttu-id="8e30f-129">**control de errores y de errores leves**: si se produce una excepción, el software intermedio puede enviar un mensaje descriptivo para esa excepción.</span><span class="sxs-lookup"><span data-stu-id="8e30f-129">**error handling or failing gracefully**: If an exception is thrown, middleware can send a user friendly message for that exception.</span></span>
- <span data-ttu-id="8e30f-130">**traducción**: este software intermedio podría detectar y traducir los mensajes entrantes, así como configurar los mensajes salientes de modo que se traduzcan al idioma de entrada detectado.</span><span class="sxs-lookup"><span data-stu-id="8e30f-130">**translation**: This middleware could detect and translate incoming messages, and set up outgoing messages to be translated back into the detected incoming language.</span></span>

<span data-ttu-id="8e30f-131">Puede definir su propio software intermedio o usar el software intermedio del SDK, que representa componentes independientes de la aplicación, como:</span><span class="sxs-lookup"><span data-stu-id="8e30f-131">You can define your own middleware, or the SDK defines some middleware that represents application-independent components, such as:</span></span>

- <span data-ttu-id="8e30f-132">Software intermedio de estado, que guarda y restaura la información de estado del objeto de contexto.</span><span class="sxs-lookup"><span data-stu-id="8e30f-132">State middleware that persists and restores state information on the context object.</span></span> <span data-ttu-id="8e30f-133">El SDK proporciona software intermedio de estado del usuario y la conversación.</span><span class="sxs-lookup"><span data-stu-id="8e30f-133">The SDK provides conversation and user state middleware.</span></span>
- <span data-ttu-id="8e30f-134">Software intermedio de traducción, que puede reconocer el idioma de entrada y traducirlo a otro lenguaje, por ejemplo, uno que entienda la aplicación.</span><span class="sxs-lookup"><span data-stu-id="8e30f-134">Translation middleware that can recognize the input language and translate to another language, such as one that your application understands.</span></span>
- <span data-ttu-id="8e30f-135">Software intermedio de registro, que puede registrar las actividades entrantes y salientes.</span><span class="sxs-lookup"><span data-stu-id="8e30f-135">Logging middleware that can record incoming and outgoing activities.</span></span>

## <a name="the-bot-middleware-pipeline"></a><span data-ttu-id="8e30f-136">La canalización de software intermedio del bot</span><span class="sxs-lookup"><span data-stu-id="8e30f-136">The bot middleware pipeline</span></span>

<span data-ttu-id="8e30f-137">Para cada actividad, el adaptador llama al software intermedio en el **orden en que se ha agregado**.</span><span class="sxs-lookup"><span data-stu-id="8e30f-137">For each activity, the adapter calls middleware in the **order in which you added it**.</span></span> <span data-ttu-id="8e30f-138">El adaptador pasa el objeto de contexto para el turno y un delegado _next_, y el software intermedio llama al delegado para pasar el control al siguiente software intermedio de la canalización.</span><span class="sxs-lookup"><span data-stu-id="8e30f-138">The adapter passes in the context object for the turn and a _next_ delegate, and the middleware calls the delegate to pass control to the next middleware in the pipeline.</span></span> <span data-ttu-id="8e30f-139">El software intermedio también puede llevar a cabo acciones después de que se devuelva el delegado _next_ antes de completar el método.</span><span class="sxs-lookup"><span data-stu-id="8e30f-139">Middleware also has an opportunity to do things after the _next_ delegate returns before completing the method.</span></span> <span data-ttu-id="8e30f-140">Es como si cada objeto de software intermedio tuviese la oportunidad de actuar directamente sobre los objetos de software intermedio que lo siguen en la canalización.</span><span class="sxs-lookup"><span data-stu-id="8e30f-140">You can think of it as each middleware object has the first-and-last chance to act with respect to the middleware objects that follow it in the pipeline.</span></span>

<span data-ttu-id="8e30f-141">Por ejemplo: </span><span class="sxs-lookup"><span data-stu-id="8e30f-141">For example:</span></span>

- <span data-ttu-id="8e30f-142">El primer controlador de turno del objeto de software intermedio ejecuta código antes de llamar a _next_.</span><span class="sxs-lookup"><span data-stu-id="8e30f-142">1st middleware object’s turn handler executes code before calling _next_.</span></span>
  - <span data-ttu-id="8e30f-143">El segundo controlador de turno del objeto de software intermedio ejecuta código antes de llamar a _next_.</span><span class="sxs-lookup"><span data-stu-id="8e30f-143">2nd middleware object’s turn handler executes code before calling _next_.</span></span>
    - <span data-ttu-id="8e30f-144">El controlador de turno del bot se ejecuta y se devuelve.</span><span class="sxs-lookup"><span data-stu-id="8e30f-144">The bot’s turn handler executes and returns.</span></span>
  - <span data-ttu-id="8e30f-145">El segundo controlador de turno del objeto de software intermedio ejecuta el código restante antes de devolver.</span><span class="sxs-lookup"><span data-stu-id="8e30f-145">2nd middleware object’s turn handler executes any remaining code before returning.</span></span>
- <span data-ttu-id="8e30f-146">El primer controlador de turno del objeto de software intermedio ejecuta el código restante antes de devolver.</span><span class="sxs-lookup"><span data-stu-id="8e30f-146">1st middleware object’s turn handler executes any remaining code before returning.</span></span>

<span data-ttu-id="8e30f-147">Si el software intermedio no llama al delegado next, el adaptador no llama a ninguno de los controladores de turno posteriores de software intermedio o bot y se produce un cortocircuito en la canalización.</span><span class="sxs-lookup"><span data-stu-id="8e30f-147">If middleware doesn’t call the next delegate, the adapter does not call any of the subsequent middleware or bot turn handlers, and the pipeline short circuits.</span></span>

<span data-ttu-id="8e30f-148">Una vez que se ha completado la canalización de software intermedio del bot, el turno acaba y el contexto de turno sale del ámbito.</span><span class="sxs-lookup"><span data-stu-id="8e30f-148">Once the bot middleware pipeline completes, the turn is over, and the turn context goes out of scope.</span></span>

<span data-ttu-id="8e30f-149">El software intermedio o el bot pueden generar respuestas y registrar los controladores de eventos de respuesta, pero debe tener en cuenta que las respuestas se controlan en procesos independientes.</span><span class="sxs-lookup"><span data-stu-id="8e30f-149">Middleware or the bot can generate responses and register response event handlers, but keep in mind that responses are handled in separate processes.</span></span>

## <a name="order-of-middleware"></a><span data-ttu-id="8e30f-150">Orden del software intermedio</span><span class="sxs-lookup"><span data-stu-id="8e30f-150">Order of middleware</span></span>

<span data-ttu-id="8e30f-151">Puesto que el orden en el que se agrega el software intermedio determina el orden en el que este procesa una actividad, es importante decidir la secuencia que se seguirá para agregar dicho software intermedio.</span><span class="sxs-lookup"><span data-stu-id="8e30f-151">Since the order in which middleware is added determines the order in which the middleware processes an activity, it's important to decide the sequence that middleware should be added.</span></span>

> [!NOTE]
> <span data-ttu-id="8e30f-152">Esto está pensado para proporcionarle un patrón común que funcione para la mayoría de los bots, pero debe tener en cuenta cómo interactuará cada fragmento de software intermedio con los demás según su situación.</span><span class="sxs-lookup"><span data-stu-id="8e30f-152">This is meant to give you a common pattern that works for most bots, but be sure to consider how each piece of middleware will interact with the others for your situation.</span></span>

<span data-ttu-id="8e30f-153">Los primeros elementos de la canalización de software intermedio probablemente serán los que se encarguen de las tareas de nivel más bajo que se usan de cada vez,</span><span class="sxs-lookup"><span data-stu-id="8e30f-153">The first things in your middleware pipeline should likely be those that take care of the lowest-level tasks that are used every time.</span></span> <span data-ttu-id="8e30f-154">como el registro, el control de excepciones, la administración de estados y la traducción, entre otras cosas.</span><span class="sxs-lookup"><span data-stu-id="8e30f-154">Examples include logging, exception handling, state management, and translation.</span></span> <span data-ttu-id="8e30f-155">El orden de estos elementos puede variar según sus necesidades, por ejemplo, si quiere que el mensaje entrante se traduzca primero, antes de que se controlen las excepciones, o si debe producirse primero el control de excepciones, lo que puede conllevar que los mensajes de excepción no se traduzcan.</span><span class="sxs-lookup"><span data-stu-id="8e30f-155">Ordering these can vary depending on your needs, such as whether you want the incoming message to be translated first, before any exceptions can be handled, or if exception handling should be first, which can mean exception messages wouldn't be translated.</span></span>

<span data-ttu-id="8e30f-156">Los últimos elementos de la canalización de software intermedio deberían ser el software intermedio específico del bot, que es el que se implementa para realizar el procesamiento de cada mensaje que se envía al bot.</span><span class="sxs-lookup"><span data-stu-id="8e30f-156">The last things in your middleware pipeline should be bot-specific middleware, which is middleware you implement to do some processing on every message sent to your bot.</span></span> <span data-ttu-id="8e30f-157">Si el software intermedio usa información de estado u otra información definida en el contexto del bot, agréguela a la canalización de software intermedio después del software intermedio que modifica el estado o el contexto.</span><span class="sxs-lookup"><span data-stu-id="8e30f-157">If your middleware uses state information or other information set in the bot context, add it to the middleware pipeline after the middleware that modifies state or context.</span></span>

## <a name="short-circuiting"></a><span data-ttu-id="8e30f-158">Cortocircuitos</span><span class="sxs-lookup"><span data-stu-id="8e30f-158">Short circuiting</span></span>

<span data-ttu-id="8e30f-159">Un concepto importante relacionado con el software intermedio (y los [controladores de eventos](~/v4sdk/bot-builder-concept-activity-processing.md#response-event-handlers)) es el _cortocircuito_.</span><span class="sxs-lookup"><span data-stu-id="8e30f-159">An important idea around middleware (and [event handlers](~/v4sdk/bot-builder-concept-activity-processing.md#response-event-handlers)) is _short circuiting_.</span></span> <span data-ttu-id="8e30f-160">Si la ejecución va a continuar por las capas siguientes, el software intermedio (o un controlador) debe pasar la ejecución mediante una llamada al delegado _next_.</span><span class="sxs-lookup"><span data-stu-id="8e30f-160">If execution is to continue through the layers that follow it, middleware (or a handler) is required to pass execution on by calling it's _next_ delegate.</span></span>  <span data-ttu-id="8e30f-161">Si no se llama al delegado next dentro de ese software intermedio (o controlador), se producirá un cortocircuito en la canalización actual y las capas posteriores no se ejecutarán.</span><span class="sxs-lookup"><span data-stu-id="8e30f-161">If the next delegate is not called within that middleware (or handler), the current pipeline will short circuit and subsequent layers are not executed.</span></span> <span data-ttu-id="8e30f-162">Esto significa que se omite toda la lógica del bot, así como el software intermedio que se encuentre más adelante en la canalización.</span><span class="sxs-lookup"><span data-stu-id="8e30f-162">This means all bot logic, and any middleware later down the pipeline, are skipped.</span></span>

<span data-ttu-id="8e30f-163">En el caso de los controladores de eventos, si no se llama a _next_ el evento se cancela, lo que supone un resultado muy diferente del que se obtiene cuando el software intermedio omite la lógica.</span><span class="sxs-lookup"><span data-stu-id="8e30f-163">For event handlers, not calling _next_ means that the event is cancelled, which is a significantly different result than middleware skipping logic.</span></span> <span data-ttu-id="8e30f-164">Al no procesar el resto del evento, el adaptador no lo envía nunca.</span><span class="sxs-lookup"><span data-stu-id="8e30f-164">By not processing the rest of the event, the adapter never sends it.</span></span>

> [!TIP]
> <span data-ttu-id="8e30f-165">Si aun así produce un cortocircuito en un evento, como `SendActivities`, asegúrese de que es el comportamiento que tenía previsto.</span><span class="sxs-lookup"><span data-stu-id="8e30f-165">If you do short-circuit an event, such as `SendActivities`, be sure it's the behavior you intend.</span></span> <span data-ttu-id="8e30f-166">En caso contrario, pueden producirse errores muy confusos.</span><span class="sxs-lookup"><span data-stu-id="8e30f-166">Otherwise, it can result in very confusing bugs.</span></span>

## <a name="next-steps"></a><span data-ttu-id="8e30f-167">Pasos siguientes</span><span class="sxs-lookup"><span data-stu-id="8e30f-167">Next steps</span></span>

<span data-ttu-id="8e30f-168">Ahora que está familiarizado con algunos conceptos clave de un bot, vamos a profundizar en la manera en que un bot puede enviar mensajes proactivos.</span><span class="sxs-lookup"><span data-stu-id="8e30f-168">Now that you're familiar with some key concepts of a bot, let's dive into the details of how a bot can send proactive messages.</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="8e30f-169">Mensajes proactivos</span><span class="sxs-lookup"><span data-stu-id="8e30f-169">Proactive Messaging</span></span>](~/v4sdk/bot-builder-proactive-messages.md)
