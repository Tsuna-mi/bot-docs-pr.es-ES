---
title: Software intermedio | Microsoft Docs
description: Descripción del software intermedio y de sus usos en el SDK del bot.
keywords: software intermedio, canalización de software intermedio, cortocircuito, usos del software intermedio
author: ivorb
ms.author: v-ivorb
manager: kamrani
ms.topic: article
ms.prod: bot-framework
ms.date: 05/24/2018
monikerRange: azure-bot-service-4.0
ms.openlocfilehash: 38f1bced73251eea11be86a76963aeaf1ec0f718
ms.sourcegitcommit: 3cb288cf2f09eaede317e1bc8d6255becf1aec61
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 09/27/2018
ms.locfileid: "47389704"
---
# <a name="middleware"></a><span data-ttu-id="99b71-104">Software intermedio</span><span class="sxs-lookup"><span data-stu-id="99b71-104">Middleware</span></span>

[!INCLUDE [pre-release-label](../includes/pre-release-label.md)]

<span data-ttu-id="99b71-105">El software intermedio es simplemente una clase que se encuentra entre el adaptador y la lógica del bot, que se agrega a la colección de software intermedio del adaptador durante la inicialización.</span><span class="sxs-lookup"><span data-stu-id="99b71-105">Middleware is simply a class that sits between the adapter and your bot logic, added to your adapter's middleware collection during initialization.</span></span> <span data-ttu-id="99b71-106">El SDK le permite escribir su propio software intermedio o agregar componentes reutilizables de software intermedio creado por otros usuarios.</span><span class="sxs-lookup"><span data-stu-id="99b71-106">The SDK allows you to write your own middleware or add reusable components of middleware created by others.</span></span> <span data-ttu-id="99b71-107">Todas las actividades que entran y salen de su bot pasan por el middleware.</span><span class="sxs-lookup"><span data-stu-id="99b71-107">Every activity coming into or out of your bot flows through your middleware.</span></span>

<span data-ttu-id="99b71-108">El adaptador procesa y dirige las actividades entrantes a través de la canalización de software intermedio del bot a la lógica del bot y, luego, otra vez de vuelta.</span><span class="sxs-lookup"><span data-stu-id="99b71-108">The adapter processes and directs incoming activities in through the bot middleware pipeline to your bot’s logic and then back out again.</span></span> <span data-ttu-id="99b71-109">Cuando las actividades entran y salen de los bots, cada fragmento de software intermedio puede inspeccionar o actuar sobre la actividad, tanto antes como después de que se ejecute la lógica del bot.</span><span class="sxs-lookup"><span data-stu-id="99b71-109">As each activity flows in and out of the bot, each piece of middleware can inspect or act upon the activity, both before and after the bot logic runs.</span></span>

<span data-ttu-id="99b71-110">Antes de centrarse en el software intermedio, es importante entender los [bots en general](~/v4sdk/bot-builder-basics.md) y [cómo procesan las actividades](~/v4sdk/bot-builder-concept-activity-processing.md).</span><span class="sxs-lookup"><span data-stu-id="99b71-110">Before jumping into middleware, it is important to understand [bots in general](~/v4sdk/bot-builder-basics.md) and [how they process activities](~/v4sdk/bot-builder-concept-activity-processing.md).</span></span>

## <a name="uses-for-middleware"></a><span data-ttu-id="99b71-111">Usos del software intermedio</span><span class="sxs-lookup"><span data-stu-id="99b71-111">Uses for middleware</span></span>
<span data-ttu-id="99b71-112">A menudo surge la siguiente pregunta: "¿Cuándo debo implementar acciones como middleware, en lugar de usar la lógica normal del bot?"</span><span class="sxs-lookup"><span data-stu-id="99b71-112">The question often comes up: "When should I implement actions as middleware versus using my normal bot logic?"</span></span> <span data-ttu-id="99b71-113">El middleware le brinda oportunidades adicionales para interactuar con el flujo de conversación de los usuarios tanto antes como después de que se procese cada _turno_ de la conversación.</span><span class="sxs-lookup"><span data-stu-id="99b71-113">Middleware provides you with additional opportunities to interact with your users' conversation flow both before and after each _turn_ of the conversation is processed.</span></span> <span data-ttu-id="99b71-114">También permite almacenar y recuperar información relativa a la conversación y llamar a una lógica de procesamiento adicional cuando sea necesario.</span><span class="sxs-lookup"><span data-stu-id="99b71-114">Middleware also allows you to store and retrieve information concerning the conversation and call additional processing logic when required.</span></span> <span data-ttu-id="99b71-115">A continuación encontrará algunos escenarios comunes que muestran situaciones en las que el middleware puede resultar útil.</span><span class="sxs-lookup"><span data-stu-id="99b71-115">Below are some common scenarios that show where middleware can be useful.</span></span>

### <a name="looking-at-or-acting-on-every-activity"></a><span data-ttu-id="99b71-116">Registrar o actuar sobre todas las actividades</span><span class="sxs-lookup"><span data-stu-id="99b71-116">Looking at or acting on every activity</span></span>
<span data-ttu-id="99b71-117">Existen muchas situaciones que requieren que un bot haga algo en todas las actividades, o bien en las actividades de un tipo determinado.</span><span class="sxs-lookup"><span data-stu-id="99b71-117">There are plenty of situations that require your bot to do something on every activity, or for every activity of a certain type.</span></span> <span data-ttu-id="99b71-118">Por ejemplo, tal vez desee registrar todas las actividades de mensajes que recibe el bot, o proporcionar una respuesta de reserva si el bot no ha generado ninguna respuesta en este turno.</span><span class="sxs-lookup"><span data-stu-id="99b71-118">For example, you may want to log every message activity your bot receives or provide a fallback response if the bot has not otherwise generated a response this turn.</span></span> <span data-ttu-id="99b71-119">El software intermedio es idóneo para hacerlo, ya que puede actuar tanto antes como después de que se haya ejecutado el resto de la lógica del bot.</span><span class="sxs-lookup"><span data-stu-id="99b71-119">Middleware is a great place for this, with its ability to act both before and after the rest of the bot logic has executed.</span></span>

### <a name="modifying-or-enhancing-the-turn-context"></a><span data-ttu-id="99b71-120">Modificar o mejorar el contexto de turno</span><span class="sxs-lookup"><span data-stu-id="99b71-120">Modifying or enhancing the turn context</span></span>
<span data-ttu-id="99b71-121">Algunas conversaciones pueden ser mucho más provechosas si el bot tiene más información de la que se proporciona en la actividad.</span><span class="sxs-lookup"><span data-stu-id="99b71-121">Certain conversations can be much more fruitful if the bot has more information than what is provided in the activity.</span></span> <span data-ttu-id="99b71-122">En este caso, el middleware podría comprobar la información de estado de la conversación que se tiene hasta el momento, consultar un origen de datos externo y anexarlo al objeto del [contexto de turno](bot-builder-concept-activity-processing.md#turn-context) antes de pasar la ejecución a la lógica del bot.</span><span class="sxs-lookup"><span data-stu-id="99b71-122">Middleware in this case could look at the conversation state information it has so far, query an external data source, and append that to the [turn context](bot-builder-concept-activity-processing.md#turn-context) object before passing execution on to the bot logic.</span></span> 

<span data-ttu-id="99b71-123">El SDK define el middleware de registro que puede grabar las actividades de entrada y salida, pero el usuario también puede definir su propio middleware.</span><span class="sxs-lookup"><span data-stu-id="99b71-123">The SDK defines logging middleware that can record incoming and outgoing activities, but You can alos define your own middleware.</span></span>

## <a name="the-bot-middleware-pipeline"></a><span data-ttu-id="99b71-124">La canalización de software intermedio del bot</span><span class="sxs-lookup"><span data-stu-id="99b71-124">The bot middleware pipeline</span></span>
<span data-ttu-id="99b71-125">Para cada actividad, el adaptador llama al middleware en el orden en que se ha agregado.</span><span class="sxs-lookup"><span data-stu-id="99b71-125">For each activity, the adapter calls middleware in the order in which you added it.</span></span> <span data-ttu-id="99b71-126">El adaptador pasa el objeto de contexto para el turno y un delegado _next_, y el software intermedio llama al delegado para pasar el control al siguiente software intermedio de la canalización.</span><span class="sxs-lookup"><span data-stu-id="99b71-126">The adapter passes in the context object for the turn and a _next_ delegate, and the middleware calls the delegate to pass control to the next middleware in the pipeline.</span></span> <span data-ttu-id="99b71-127">El software intermedio también puede llevar a cabo acciones después de que se devuelva el delegado _next_ antes de completar el método.</span><span class="sxs-lookup"><span data-stu-id="99b71-127">Middleware also has an opportunity to do things after the _next_ delegate returns before completing the method.</span></span> <span data-ttu-id="99b71-128">Es como si cada objeto de software intermedio tuviese la oportunidad de actuar directamente sobre los objetos de software intermedio que lo siguen en la canalización.</span><span class="sxs-lookup"><span data-stu-id="99b71-128">You can think of it as each middleware object has the first-and-last chance to act with respect to the middleware objects that follow it in the pipeline.</span></span>

<span data-ttu-id="99b71-129">Por ejemplo: </span><span class="sxs-lookup"><span data-stu-id="99b71-129">For example:</span></span>

- <span data-ttu-id="99b71-130">El primer controlador de turno del objeto de software intermedio ejecuta código antes de llamar a _next_.</span><span class="sxs-lookup"><span data-stu-id="99b71-130">1st middleware object’s turn handler executes code before calling _next_.</span></span>
  - <span data-ttu-id="99b71-131">El segundo controlador de turno del objeto de software intermedio ejecuta código antes de llamar a _next_.</span><span class="sxs-lookup"><span data-stu-id="99b71-131">2nd middleware object’s turn handler executes code before calling _next_.</span></span>
    - <span data-ttu-id="99b71-132">El controlador de turno del bot se ejecuta y se devuelve.</span><span class="sxs-lookup"><span data-stu-id="99b71-132">The bot’s turn handler executes and returns.</span></span>
  - <span data-ttu-id="99b71-133">El segundo controlador de turno del objeto de software intermedio ejecuta el código restante antes de devolver.</span><span class="sxs-lookup"><span data-stu-id="99b71-133">2nd middleware object’s turn handler executes any remaining code before returning.</span></span>
- <span data-ttu-id="99b71-134">El primer controlador de turno del objeto de software intermedio ejecuta el código restante antes de devolver.</span><span class="sxs-lookup"><span data-stu-id="99b71-134">1st middleware object’s turn handler executes any remaining code before returning.</span></span>

<span data-ttu-id="99b71-135">Si el software intermedio no llama al delegado next, el adaptador no llama a ninguno de los controladores de turno posteriores de software intermedio o bot y se produce un cortocircuito en la canalización.</span><span class="sxs-lookup"><span data-stu-id="99b71-135">If middleware doesn’t call the next delegate, the adapter does not call any of the subsequent middleware or bot turn handlers, and the pipeline short circuits.</span></span>

<span data-ttu-id="99b71-136">Una vez que se ha completado la canalización de software intermedio del bot, el turno acaba y el contexto de turno sale del ámbito.</span><span class="sxs-lookup"><span data-stu-id="99b71-136">Once the bot middleware pipeline completes, the turn is over, and the turn context goes out of scope.</span></span>

<span data-ttu-id="99b71-137">El software intermedio o el bot pueden generar respuestas y registrar los controladores de eventos de respuesta, pero debe tener en cuenta que las respuestas se controlan en procesos independientes.</span><span class="sxs-lookup"><span data-stu-id="99b71-137">Middleware or the bot can generate responses and register response event handlers, but keep in mind that responses are handled in separate processes.</span></span>

## <a name="order-of-middleware"></a><span data-ttu-id="99b71-138">Orden del software intermedio</span><span class="sxs-lookup"><span data-stu-id="99b71-138">Order of middleware</span></span>
<span data-ttu-id="99b71-139">Puesto que el orden en el que se agrega el software intermedio determina el orden en el que este procesa una actividad, es importante decidir la secuencia que se seguirá para agregar dicho software intermedio.</span><span class="sxs-lookup"><span data-stu-id="99b71-139">Since the order in which middleware is added determines the order in which the middleware processes an activity, it's important to decide the sequence that middleware should be added.</span></span>

> [!NOTE]
> <span data-ttu-id="99b71-140">Esto está pensado para proporcionarle un patrón común que funcione para la mayoría de los bots, pero debe tener en cuenta cómo interactuará cada fragmento de software intermedio con los demás según su situación.</span><span class="sxs-lookup"><span data-stu-id="99b71-140">This is meant to give you a common pattern that works for most bots, but be sure to consider how each piece of middleware will interact with the others for your situation.</span></span>

<span data-ttu-id="99b71-141">Los primeros elementos de la canalización de software intermedio probablemente serán los que se encarguen de las tareas de nivel más bajo que se usan de cada vez,</span><span class="sxs-lookup"><span data-stu-id="99b71-141">The first things in your middleware pipeline should likely be those that take care of the lowest-level tasks that are used every time.</span></span> <span data-ttu-id="99b71-142">como el registro, el control de excepciones y la traducción.</span><span class="sxs-lookup"><span data-stu-id="99b71-142">Examples include logging, exception handling, and translation.</span></span> <span data-ttu-id="99b71-143">El orden de estos elementos puede variar en función de sus necesidades, por ejemplo, si quiere que el mensaje entrante se traduzca primero, antes de que se guarden los mensajes, o si primero se deben almacenar, lo que podría significar que los mensajes almacenados no se traducirían.</span><span class="sxs-lookup"><span data-stu-id="99b71-143">Ordering these can vary depending on your needs, such as whether you want the incoming message to be translated first, before messages are stored, or if message storage should occur first, which could mean stored messages wouldn't be translated.</span></span>

<span data-ttu-id="99b71-144">Los últimos elementos de la canalización de software intermedio deberían ser el software intermedio específico del bot, que es el que se implementa para realizar el procesamiento de cada mensaje que se envía al bot.</span><span class="sxs-lookup"><span data-stu-id="99b71-144">The last things in your middleware pipeline should be bot-specific middleware, which is middleware you implement to do some processing on every message sent to your bot.</span></span> <span data-ttu-id="99b71-145">Si el software intermedio usa información de estado u otra información definida en el contexto del bot, agréguela a la canalización de software intermedio después del software intermedio que modifica el estado o el contexto.</span><span class="sxs-lookup"><span data-stu-id="99b71-145">If your middleware uses state information or other information set in the bot context, add it to the middleware pipeline after the middleware that modifies state or context.</span></span>

## <a name="short-circuiting"></a><span data-ttu-id="99b71-146">Cortocircuitos</span><span class="sxs-lookup"><span data-stu-id="99b71-146">Short circuiting</span></span>
<span data-ttu-id="99b71-147">Un concepto importante relacionado con el middleware (y los [controladores de respuestas](./bot-builder-concept-activity-processing.md#response-event-handlers)) es el _cortocircuito_.</span><span class="sxs-lookup"><span data-stu-id="99b71-147">An important idea around middleware (and [response handlers](./bot-builder-concept-activity-processing.md#response-event-handlers)) is _short circuiting_.</span></span> <span data-ttu-id="99b71-148">Si la ejecución va a continuar por las capas siguientes, el middleware (o un controlador de respuestas) debe pasar la ejecución mediante una llamada al delegado _next_.</span><span class="sxs-lookup"><span data-stu-id="99b71-148">If execution is to continue through the layers that follow it, middleware (or a response handler) is required to pass execution on by calling it's _next_ delegate.</span></span>  <span data-ttu-id="99b71-149">Si no se llama al delegado next en dicho middleware (o controlador de respuestas), se producirá un cortocircuito en la canalización asociada y las capas posteriores no se ejecutarán,</span><span class="sxs-lookup"><span data-stu-id="99b71-149">If the next delegate is not called within that middleware (or response handler), the associated pipeline short circuits and subsequent layers are not executed.</span></span> <span data-ttu-id="99b71-150">lo que significa que se omiten no solo toda la lógica del bot, sino también el middleware posterior de la canalización.</span><span class="sxs-lookup"><span data-stu-id="99b71-150">This means all bot logic, and any middleware further along the pipeline, is skipped.</span></span> <span data-ttu-id="99b71-151">Hay una sutil diferencia entre que el middleware cortocircuite un turno y que lo haga el controlador de respuestas.</span><span class="sxs-lookup"><span data-stu-id="99b71-151">There is a subtle difference between your middleware and your response handler short circuiting a turn.</span></span>

<span data-ttu-id="99b71-152">Si el middleware cortocircuita un turno, no se llama al controlador de turnos del bot, pero todo el código del middleware que se haya ejecutado antes de ese momento en la canalización se seguirá ejecutando hasta su finalización.</span><span class="sxs-lookup"><span data-stu-id="99b71-152">When middleware short circuits a turn, your bot turn handler will not be called, but all middleware code executed prior to this point in the pipeline will still run to completion.</span></span> 

<span data-ttu-id="99b71-153">En el caso de los controladores de eventos, si no se llama a _next_ el evento se cancela, lo que supone un resultado muy diferente del que se obtiene cuando el software intermedio omite la lógica.</span><span class="sxs-lookup"><span data-stu-id="99b71-153">For event handlers, not calling _next_ means that the event is cancelled, which is a significantly different result than middleware skipping logic.</span></span> <span data-ttu-id="99b71-154">Al no procesar el resto del evento, el adaptador no lo envía nunca.</span><span class="sxs-lookup"><span data-stu-id="99b71-154">By not processing the rest of the event, the adapter never sends it.</span></span>

> [!TIP]
> <span data-ttu-id="99b71-155">Si provoca un cortocircuito en un evento de respuestas, como `SendActivities`, asegúrese de que es el comportamiento que tenía previsto.</span><span class="sxs-lookup"><span data-stu-id="99b71-155">If you do short-circuit a response event, such as `SendActivities`, be sure it's the behavior you intend.</span></span> <span data-ttu-id="99b71-156">De lo contrario, puede resultar muy difícil solucionar los errores.</span><span class="sxs-lookup"><span data-stu-id="99b71-156">Otherwise, it can result in difficult to fix bugs.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="99b71-157">Recursos adicionales</span><span class="sxs-lookup"><span data-stu-id="99b71-157">Additional resources</span></span>
<span data-ttu-id="99b71-158">Puede echar un vistazo al middleware del registrador de transcripciones, tal como está implementado en el SDK Bot Builder [[C#](https://github.com/Microsoft/botbuilder-dotnet/blob/master/libraries/Microsoft.Bot.Builder/TranscriptLoggerMiddleware.cs)|[JS](https://github.com/Microsoft/botbuilder-js/blob/master/libraries/botbuilder-core/src/transcriptLogger.ts)].</span><span class="sxs-lookup"><span data-stu-id="99b71-158">You can take a look at the transcript logger middleware, as implemented in the Bot Builder SDK [[C#](https://github.com/Microsoft/botbuilder-dotnet/blob/master/libraries/Microsoft.Bot.Builder/TranscriptLoggerMiddleware.cs)|[JS](https://github.com/Microsoft/botbuilder-js/blob/master/libraries/botbuilder-core/src/transcriptLogger.ts)].</span></span>
